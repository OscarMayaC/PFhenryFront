import{ExtensionProperty as e,PropertyType as t,COPY_IDENTITY as s,GraphChildList as r,Extension as o,BufferUtils as n,WriterContext as i,Primitive as a,AnimationSampler as c,AnimationChannel as u,Accessor as h,MathUtils as l,GLB_BUFFER as p,ImageUtils as f,bounds as d,ColorUtils as x,TextureInfo as T,GraphChild as g,TextureChannel as m}from"@gltf-transform/core";import{read as _,KTX2Model as E}from"ktx-parse";function C(e,t,s,r){var o,n=arguments.length,i=n<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,s,r);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(i=(n<3?o(i):n>3?o(t,s,i):o(t,s))||i);return n>3&&i&&Object.defineProperty(t,s,i),i}class I extends e{constructor(...e){super(...e),this.propertyType="InstancedMesh",this.parentTypes=[t.NODE],this.extensionName="EXT_mesh_gpu_instancing",this.attributes=[]}copy(e,t=s){return super.copy(e,t),this.clearGraphChildList(this.attributes),e.listSemantics().forEach(s=>{this.setAttribute(s,t(e.getAttribute(s)))}),this}getAttribute(e){const t=this.attributes.find(t=>t.semantic===e);return t?t.getChild():null}setAttribute(e,t){const s=this.getAttribute(e);if(s&&this.removeGraphChild(this.attributes,s),!t)return this;const r=this.graph.linkAttribute(e.toLowerCase(),this,t);return r.semantic=e,this.addGraphChild(this.attributes,r)}listAttributes(){return this.attributes.map(e=>e.getChild())}listSemantics(){return this.attributes.map(e=>e.semantic)}}I.EXTENSION_NAME="EXT_mesh_gpu_instancing",C([r],I.prototype,"attributes",void 0);const y="EXT_mesh_gpu_instancing";class N extends o{constructor(...e){super(...e),this.extensionName=y,this.provideTypes=[t.NODE],this.prewriteTypes=[t.ACCESSOR]}createInstancedMesh(){return new I(this.doc.getGraph(),this)}read(e){return(e.jsonDoc.json.nodes||[]).forEach((t,s)=>{if(!t.extensions||!t.extensions[y])return;const r=t.extensions[y],o=this.createInstancedMesh();for(const t in r.attributes)o.setAttribute(t,e.accessors[r.attributes[t]]);e.nodes[s].setExtension(y,o)}),this}prewrite(e){e.accessorUsageGroupedByParent.add("INSTANCE_ATTRIBUTE");for(const t of this.properties)for(const s of t.listAttributes())e.addAccessorToUsageGroup(s,"INSTANCE_ATTRIBUTE");return this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listNodes().forEach(s=>{const r=s.getExtension(y);if(r){const o=e.nodeIndexMap.get(s),n=t.json.nodes[o],i={attributes:{}};r.listSemantics().forEach(t=>{const s=r.getAttribute(t);i.attributes[t]=e.accessorIndexMap.get(s)}),n.extensions=n.extensions||{},n.extensions[y]=i}}),this}}function R(){return(R=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e}).apply(this,arguments)}var A,S,F;N.EXTENSION_NAME=y,function(e){e.QUANTIZE="quantize",e.FILTER="filter"}(A||(A={})),function(e){e.ATTRIBUTES="ATTRIBUTES",e.TRIANGLES="TRIANGLES",e.INDICES="INDICES"}(S||(S={})),function(e){e.NONE="NONE",e.OCTAHEDRAL="OCTAHEDRAL",e.QUATERNION="QUATERNION",e.EXPONENTIAL="EXPONENTIAL"}(F||(F={}));const{BYTE:w,SHORT:O,FLOAT:M}=h.ComponentType,{normalize:b,denormalize:D}=l;function v(e,t,s,r){const{filter:o,bits:i}=r,a={array:e.getArray(),byteStride:e.getElementSize()*e.getComponentSize(),componentType:e.getComponentType(),normalized:e.getNormalized()};if(s!==S.ATTRIBUTES)return a;if(o!==F.NONE){let s=e.getNormalized()?function(e){const t=e.getComponentType(),s=e.getArray(),r=new Float32Array(s.length);for(let e=0;e<s.length;e++)r[e]=D(s[e],t);return r}(e):new Float32Array(a.array);switch(o){case F.EXPONENTIAL:a.byteStride=4*e.getElementSize(),a.componentType=M,a.normalized=!1,a.array=t.encodeFilterExp(s,e.getCount(),a.byteStride,i);break;case F.OCTAHEDRAL:a.byteStride=i>8?8:4,a.componentType=i>8?O:w,a.normalized=!0,s=3===e.getElementSize()?function(e){const t=new Float32Array(4*e.length/3);for(let s=0,r=e.length/3;s<r;s++)t[4*s]=e[3*s],t[4*s+1]=e[3*s+1],t[4*s+2]=e[3*s+2];return t}(s):s,a.array=t.encodeFilterOct(s,e.getCount(),a.byteStride,i);break;case F.QUATERNION:a.byteStride=8,a.componentType=O,a.normalized=!0,a.array=t.encodeFilterQuat(s,e.getCount(),a.byteStride,i);break;default:throw new Error("Invalid filter.")}a.min=e.getMin([]),a.max=e.getMax([]),e.getNormalized()&&(a.min=a.min.map(t=>D(t,e.getComponentType())),a.max=a.max.map(t=>D(t,e.getComponentType()))),a.normalized&&(a.min=a.min.map(e=>b(e,a.componentType)),a.max=a.max.map(e=>b(e,a.componentType)))}else a.byteStride%4&&(a.array=function(e,t){const s=n.padNumber(e.BYTES_PER_ELEMENT*t)/e.BYTES_PER_ELEMENT,r=new e.constructor(e.length/t*s);for(let o=0;o*t<e.length;o++)for(let n=0;n<t;n++)r[o*s+n]=e[o*t+n];return r}(a.array,e.getElementSize()),a.byteStride=a.array.byteLength/e.getCount());return a}function G(e,t){return t===i.BufferViewUsage.ELEMENT_ARRAY_BUFFER?e.listParents().some(e=>e instanceof a&&e.getMode()===a.Mode.TRIANGLES)?S.TRIANGLES:S.INDICES:S.ATTRIBUTES}function j(e,t){const s=t.getGraph().listParentLinks(e).map(e=>e.getName()).filter(e=>"accessor"!==e);for(const t of s){if("indices"===t)return{filter:F.NONE};if("POSITION"===t)return{filter:F.NONE};if("TEXCOORD_0"===t)return{filter:F.NONE};if("NORMAL"===t)return{filter:F.OCTAHEDRAL,bits:8};if("TANGENT"===t)return{filter:F.OCTAHEDRAL,bits:8};if(t.startsWith("JOINTS_"))return{filter:F.NONE};if(t.startsWith("WEIGHTS_"))return{filter:F.NONE};if("output"===t){const t=B(e);return"rotation"===t?{filter:F.QUATERNION,bits:16}:"translation"===t||"scale"===t?{filter:F.EXPONENTIAL,bits:12}:{filter:F.NONE}}if("input"===t)return{filter:F.EXPONENTIAL,bits:12};if("inverseBindMatrices"===t)return{filter:F.NONE}}return{filter:F.NONE}}function B(e){for(const t of e.listParents())if(t instanceof c)for(const e of t.listParents())if(e instanceof u)return e.getTargetPath();return null}const k="EXT_meshopt_compression",L={method:A.QUANTIZE};class U extends o{constructor(...e){super(...e),this.extensionName=k,this.prereadTypes=[t.BUFFER,t.PRIMITIVE],this.prewriteTypes=[t.BUFFER,t.ACCESSOR],this.readDependencies=["meshopt.decoder"],this.writeDependencies=["meshopt.encoder"],this._decoder=null,this._decoderFallbackBufferMap=new Map,this._encoder=null,this._encoderOptions=L,this._encoderFallbackBuffer=null,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={}}install(e,t){return"meshopt.decoder"===e&&(this._decoder=t),"meshopt.encoder"===e&&(this._encoder=t),this}setEncoderOptions(e){return this._encoderOptions=R({},L,e),this}preread(e,s){if(!this._decoder){if(!this.isRequired())return this;throw new Error(`[${k}] Please install extension dependency, "meshopt.decoder".`)}if(!this._decoder.supported){if(!this.isRequired())return this;throw new Error(`[${k}]: Missing WASM support.`)}return s===t.BUFFER?this._prereadBuffers(e):s===t.PRIMITIVE&&this._prereadPrimitives(e),this}_prereadBuffers(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach((s,r)=>{if(!s.extensions||!s.extensions[k])return;const o=s.extensions[k],n=o.byteOffset||0,i=o.byteLength||0,a=o.count,c=o.byteStride,u=new Uint8Array(new ArrayBuffer(a*c)),h=t.json.buffers[s.buffer],l=new Uint8Array(h.uri?t.resources[h.uri]:t.resources[p],n,i);this._decoder.decodeGltfBuffer(u,a,c,l,o.mode,o.filter),e.bufferViews[r]=u})}_prereadPrimitives(e){const t=e.jsonDoc;(t.json.bufferViews||[]).forEach(s=>{var r;s.extensions&&s.extensions[k]&&(r=t.json.buffers[s.buffer]).extensions&&r.extensions.EXT_meshopt_compression&&r.extensions.EXT_meshopt_compression.fallback&&this._decoderFallbackBufferMap.set(e.buffers[s.buffer],e.buffers[s.extensions[k].buffer])})}read(e){if(!this.isRequired())return this;for(const[e,t]of this._decoderFallbackBufferMap){for(const s of e.listParents())s instanceof h&&s.swap(e,t);e.dispose()}return this}prewrite(e,s){return s===t.ACCESSOR?this._prewriteAccessors(e):s===t.BUFFER&&this._prewriteBuffers(e),this}_prewriteAccessors(e){const t=e.jsonDoc.json,s=this._encoder,r=this._encoderOptions,o=this.doc.createBuffer(),n=this.doc.getRoot().listBuffers().indexOf(o);this._encoderFallbackBuffer=o,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={};for(const o of this.doc.getRoot().listAccessors()){if("weights"===B(o))continue;const a=e.getAccessorUsage(o),c=G(o,a),u=r.method===A.FILTER?j(o,this.doc):{filter:F.NONE},h=v(o,s,c,u),{array:l,byteStride:p}=h,f=o.getBuffer();if(!f)throw new Error(`${k}: Missing buffer for accessor.`);const d=this.doc.getRoot().listBuffers().indexOf(f),x=[a,c,u,p,d].join(":");let T=this._encoderBufferViews[x],g=this._encoderBufferViewData[x],m=this._encoderBufferViewAccessors[x];T&&g||(m=this._encoderBufferViewAccessors[x]=[],g=this._encoderBufferViewData[x]=[],T=this._encoderBufferViews[x]={buffer:n,target:i.USAGE_TO_TARGET[a],byteOffset:0,byteLength:0,byteStride:a===i.BufferViewUsage.ARRAY_BUFFER?p:void 0,extensions:{[k]:{buffer:d,byteOffset:0,byteLength:0,mode:c,filter:u.filter!==F.NONE?u.filter:void 0,byteStride:p,count:0}}});const _=e.createAccessorDef(o);_.componentType=h.componentType,_.normalized=h.normalized,_.byteOffset=T.byteLength,_.min&&h.min&&(_.min=h.min),_.max&&h.max&&(_.max=h.max),e.accessorIndexMap.set(o,t.accessors.length),t.accessors.push(_),m.push(_),g.push(l.slice().buffer),T.byteLength+=l.byteLength,T.extensions.EXT_meshopt_compression.count+=o.getCount()}}_prewriteBuffers(e){const t=this._encoder;for(const s in this._encoderBufferViews){const r=this._encoderBufferViews[s],o=this._encoderBufferViewData[s],i=this.doc.getRoot().listBuffers()[r.extensions[k].buffer],a=e.otherBufferViews.get(i)||[],{count:c,byteStride:u,mode:h}=r.extensions[k],l=new Uint8Array(n.concat(o)),p=t.encodeGltfBuffer(l,c,u,h),f=n.pad(p.slice().buffer);r.extensions[k].byteLength=p.byteLength,o.length=0,o.push(f),a.push(f),e.otherBufferViews.set(i,a)}}write(e){let t=0;for(const s in this._encoderBufferViews){const r=this._encoderBufferViews[s],o=e.otherBufferViewsIndexMap.get(this._encoderBufferViewData[s][0]),i=this._encoderBufferViewAccessors[s];for(const e of i)e.bufferView=o;const a=e.jsonDoc.json.bufferViews[o],c=a.byteOffset||0;Object.assign(a,r),a.byteOffset=t,a.extensions[k].byteOffset=c,t+=n.padNumber(r.byteLength)}const s=this._encoderFallbackBuffer,r=e.bufferIndexMap.get(s),o=e.jsonDoc.json.buffers[r];return o.byteLength=t,o.extensions={[k]:{fallback:!0}},s.dispose(),this}}U.EXTENSION_NAME=k,U.EncoderMethod=A;const H="EXT_texture_webp";class V{getSize(e){const t=n.decodeText(e.slice(0,4)),s=n.decodeText(e.slice(8,12));if("RIFF"!==t||"WEBP"!==s)return null;const r=new DataView(e);let o=12;for(;o<e.byteLength;){const t=n.decodeText(e.slice(o,o+4)),s=r.getUint32(o+4,!0);if("VP8 "===t)return[16383&r.getInt16(o+14,!0),16383&r.getInt16(o+16,!0)];if("VP8L"===t){const e=r.getUint8(o+9),t=r.getUint8(o+10),s=r.getUint8(o+11);return[1+((63&t)<<8|e),1+((15&r.getUint8(o+12))<<10|s<<2|(192&t)>>6)]}o+=8+s+s%2}return null}getChannels(e){return 4}}class P extends o{constructor(...e){super(...e),this.extensionName=H,this.prereadTypes=[t.TEXTURE]}static register(){f.registerFormat("image/webp",new V)}preread(e){return(e.jsonDoc.json.textures||[]).forEach(e=>{e.extensions&&e.extensions[H]&&(e.source=e.extensions[H].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listTextures().forEach(s=>{if("image/webp"===s.getMimeType()){const r=e.imageIndexMap.get(s);(t.json.textures||[]).forEach(e=>{e.source===r&&(e.extensions=e.extensions||{},e.extensions[H]={source:e.source},delete e.source)})}}),this}}P.EXTENSION_NAME=H;const X="KHR_draco_mesh_compression";let K,z,q,$;function Y(e,t){const s=new K.DecoderBuffer;try{if(s.Init(t,t.length),e.GetEncodedGeometryType(s)!==K.TRIANGULAR_MESH)throw new Error(`[${X}] Unknown geometry type.`);const r=new K.Mesh;if(!e.DecodeBufferToMesh(s,r).ok()||0===r.ptr)throw new Error(`[${X}] Decoding failure.`);return r}finally{K.destroy(s)}}function Q(e,t){const s=3*t.num_faces();let r,o;if(t.num_points()<=65534){const n=s*Uint16Array.BYTES_PER_ELEMENT;r=K._malloc(n),e.GetTrianglesUInt16Array(t,n,r),o=new Uint16Array(K.HEAPU16.buffer,r,s).slice()}else{const n=s*Uint32Array.BYTES_PER_ELEMENT;r=K._malloc(n),e.GetTrianglesUInt32Array(t,n,r),o=new Uint32Array(K.HEAPU32.buffer,r,s).slice()}return K._free(r),o}function W(e,t,s,r){const o=q[r.componentType],n=z[r.componentType],i=s.num_components(),a=t.num_points()*i,c=a*n.BYTES_PER_ELEMENT,u=K._malloc(c);e.GetAttributeDataArrayForAllPoints(t,s,o,c,u);const h=new n(K.HEAPF32.buffer,u,a).slice();return K._free(u),h}var J,Z;!function(e){e[e.EDGEBREAKER=1]="EDGEBREAKER",e[e.SEQUENTIAL=0]="SEQUENTIAL"}(J||(J={})),function(e){e.POSITION="POSITION",e.NORMAL="NORMAL",e.COLOR="COLOR",e.TEX_COORD="TEX_COORD",e.GENERIC="GENERIC"}(Z||(Z={}));const ee={[Z.POSITION]:14,[Z.NORMAL]:10,[Z.COLOR]:8,[Z.TEX_COORD]:12,[Z.GENERIC]:12},te={decodeSpeed:5,encodeSpeed:5,method:J.EDGEBREAKER,quantizationBits:ee,quantizationVolume:"mesh"};function se(e,t=te){const s=R({},te,t);s.quantizationBits=R({},ee,t.quantizationBits);const r=new $.Encoder,o=new $.MeshBuilder,n=new $.Mesh,i={},a=new $.DracoInt8Array;for(const t of e.listSemantics()){const a=e.getAttribute(t),c=re(t),u=oe(o,a.getComponentType(),n,$[c],a.getCount(),a.getElementSize(),a.getArray());if(-1===u)throw new Error(`Error compressing "${t}" attribute.`);if(i[t]=u,"mesh"===s.quantizationVolume||"POSITION"!==t)r.SetAttributeQuantization($[c],s.quantizationBits[c]);else{if("object"!=typeof s.quantizationVolume)throw new Error("Invalid quantization volume state.");{const{quantizationVolume:e}=s,t=Math.max(e.max[0]-e.min[0],e.max[1]-e.min[1],e.max[2]-e.min[2]);r.SetAttributeExplicitQuantization($[c],s.quantizationBits[c],a.getElementSize(),e.min,t)}}}const c=e.getIndices();if(!c)throw new Error("Primitive must have indices.");o.AddFacesToMesh(n,c.getCount()/3,c.getArray()),r.SetSpeedOptions(s.encodeSpeed,s.decodeSpeed),r.SetTrackEncodedProperties(!0),s.method===J.SEQUENTIAL||e.listTargets().length>0?r.SetEncodingMethod($.MESH_SEQUENTIAL_ENCODING):r.SetEncodingMethod($.MESH_EDGEBREAKER_ENCODING);const u=r.EncodeMeshToDracoBuffer(n,a);if(u<=0)throw new Error("Error applying Draco compression.");const h=new Uint8Array(u);for(let e=0;e<u;++e)h[e]=a.GetValue(e);const l=e.getAttribute("POSITION").getCount(),p=r.GetNumberOfEncodedPoints(),f=3*r.GetNumberOfEncodedFaces();if(e.listTargets().length>0&&p!==l)throw new Error('Compression reduced vertex count unexpectedly, corrupting morph targets. Applying the "weld" function before compression may resolve the issue.');return $.destroy(a),$.destroy(n),$.destroy(o),$.destroy(r),{numVertices:p,numIndices:f,data:h,attributeIDs:i}}function re(e){return"POSITION"===e?Z.POSITION:"NORMAL"===e?Z.NORMAL:e.startsWith("COLOR_")?Z.COLOR:e.startsWith("TEXCOORD_")?Z.TEX_COORD:Z.GENERIC}function oe(e,t,s,r,o,n,i){switch(t){case h.ComponentType.UNSIGNED_BYTE:return e.AddUInt8Attribute(s,r,o,n,i);case h.ComponentType.BYTE:return e.AddInt8Attribute(s,r,o,n,i);case h.ComponentType.UNSIGNED_SHORT:return e.AddUInt16Attribute(s,r,o,n,i);case h.ComponentType.SHORT:return e.AddInt16Attribute(s,r,o,n,i);case h.ComponentType.UNSIGNED_INT:return e.AddUInt32Attribute(s,r,o,n,i);case h.ComponentType.FLOAT:return e.AddFloatAttribute(s,r,o,n,i);default:throw new Error(`Unexpected component type, "${t}".`)}}const ne="KHR_draco_mesh_compression";class ie extends o{constructor(...e){super(...e),this.extensionName=ne,this.prereadTypes=[t.PRIMITIVE],this.prewriteTypes=[t.ACCESSOR],this.readDependencies=["draco3d.decoder"],this.writeDependencies=["draco3d.encoder"],this._decoderModule=null,this._encoderModule=null,this._encoderOptions={}}install(e,t){return"draco3d.decoder"===e&&(this._decoderModule=t,K=this._decoderModule,z={[h.ComponentType.FLOAT]:Float32Array,[h.ComponentType.UNSIGNED_INT]:Uint32Array,[h.ComponentType.UNSIGNED_SHORT]:Uint16Array,[h.ComponentType.UNSIGNED_BYTE]:Uint8Array,[h.ComponentType.SHORT]:Int16Array,[h.ComponentType.BYTE]:Int8Array},q={[h.ComponentType.FLOAT]:K.DT_FLOAT32,[h.ComponentType.UNSIGNED_INT]:K.DT_UINT32,[h.ComponentType.UNSIGNED_SHORT]:K.DT_UINT16,[h.ComponentType.UNSIGNED_BYTE]:K.DT_UINT8,[h.ComponentType.SHORT]:K.DT_INT16,[h.ComponentType.BYTE]:K.DT_INT8}),"draco3d.encoder"===e&&(this._encoderModule=t,$=this._encoderModule),this}setEncoderOptions(e){return this._encoderOptions=e,this}preread(e){if(!this._decoderModule)throw new Error(`[${ne}] Please install extension dependency, "draco3d.decoder".`);const t=this.doc.getLogger(),s=e.jsonDoc,r=new Map;try{const o=s.json.meshes||[];for(const n of o)for(const o of n.primitives){if(!o.extensions||!o.extensions[ne])continue;const n=o.extensions[ne];let[i,a]=r.get(n.bufferView)||[];if(!a||!i){const e=s.json.bufferViews[n.bufferView],o=s.json.buffers[e.buffer],c=new Int8Array(o.uri?s.resources[o.uri]:s.resources[p],e.byteOffset||0,e.byteLength);i=new this._decoderModule.Decoder,a=Y(i,c),r.set(n.bufferView,[i,a]),t.debug(`[${ne}] Decompressed ${c.byteLength} bytes.`)}for(const t in o.attributes){const s=e.jsonDoc.json.accessors[o.attributes[t]],r=i.GetAttributeByUniqueId(a,n.attributes[t]),c=W(i,a,r,s);e.accessors[o.attributes[t]].setArray(c)}void 0!==o.indices&&e.accessors[o.indices].setArray(Q(i,a))}}finally{for(const[e,t]of Array.from(r.values()))this._decoderModule.destroy(e),this._decoderModule.destroy(t)}return this}read(e){return this}prewrite(e,t){if(!this._encoderModule)throw new Error(`[${ne}] Please install extension dependency, "draco3d.encoder".`);const s=this.doc.getLogger();s.debug(`[${ne}] Compression options: ${JSON.stringify(this._encoderOptions)}`);const r=function(e){const t=e.getLogger(),s=new Set,r=new Set;for(const o of e.getRoot().listMeshes())for(const e of o.listPrimitives())e.getIndices()?e.getMode()!==a.Mode.TRIANGLES?(r.add(e),t.warn(`[${ne}] Skipping Draco compression on non-TRIANGLES primitive.`)):s.add(e):(r.add(e),t.warn(`[${ne}] Skipping Draco compression on non-indexed primitive.`));const o=e.getRoot().listAccessors(),n=new Map;for(let e=0;e<o.length;e++)n.set(o[e],e);const i=new Map,c=new Set,u=new Map;for(const t of Array.from(s)){let s=ae(t,n);if(c.has(s))u.set(t,s);else{if(i.has(t.getIndices())){const s=t.getIndices(),r=s.clone();n.set(r,e.getRoot().listAccessors().length-1),t.swap(s,r)}for(const s of t.listAttributes())if(i.has(s)){const r=s.clone();n.set(r,e.getRoot().listAccessors().length-1),t.swap(s,r)}s=ae(t,n),c.add(s),u.set(t,s),i.set(t.getIndices(),s);for(const e of t.listAttributes())i.set(e,s)}}for(const e of Array.from(i.keys())){const t=new Set(e.listParents().map(e=>e.propertyType));if(2!==t.size||!t.has("Primitive")||!t.has("Root"))throw new Error(`[${ne}] Compressed accessors must only be used as indices or vertex attributes.`)}for(const e of Array.from(s)){const t=u.get(e),s=e.getIndices();if(i.get(s)!==t||e.listAttributes().some(e=>i.get(e)!==t))throw new Error(`[${ne}] Draco primitives must share all, or no, accessors.`)}for(const e of Array.from(r)){const t=e.getIndices();if(i.has(t)||e.listAttributes().some(e=>i.has(e)))throw new Error(`[${ne}] Accessor cannot be shared by compressed and uncompressed primitives.`)}return u}(this.doc),o=new Map;let n="mesh";"scene"===this._encoderOptions.quantizationVolume&&(1!==this.doc.getRoot().listScenes().length?s.warn(`[${ne}]: quantizationVolume=scene requires exactly 1 scene.`):n=d(this.doc.getRoot().listScenes().pop()));for(const t of Array.from(r.keys())){const s=r.get(t);if(!s)throw new Error("Unexpected primitive.");if(o.has(s)){o.set(s,o.get(s));continue}const i=t.getIndices(),a=e.jsonDoc.json.accessors,c=se(t,R({},this._encoderOptions,{quantizationVolume:n}));o.set(s,c);const u=e.createAccessorDef(i);u.count=c.numIndices,e.accessorIndexMap.set(i,a.length),a.push(u);for(const s of t.listSemantics()){const r=t.getAttribute(s),o=e.createAccessorDef(r);o.count=c.numVertices,e.accessorIndexMap.set(r,a.length),a.push(o)}const h=t.getAttribute("POSITION").getBuffer()||this.doc.getRoot().listBuffers()[0];e.otherBufferViews.has(h)||e.otherBufferViews.set(h,[]),e.otherBufferViews.get(h).push(c.data)}return s.debug(`[${ne}] Compressed ${r.size} primitives.`),e.extensionData[ne]={primitiveHashMap:r,primitiveEncodingMap:o},this}write(e){const t=e.extensionData[ne];for(const s of this.doc.getRoot().listMeshes()){const r=e.jsonDoc.json.meshes[e.meshIndexMap.get(s)];for(let o=0;o<s.listPrimitives().length;o++){const n=s.listPrimitives()[o],i=r.primitives[o],a=t.primitiveHashMap.get(n);if(!a)continue;const c=t.primitiveEncodingMap.get(a);i.extensions=i.extensions||{},i.extensions[ne]={bufferView:e.otherBufferViewsIndexMap.get(c.data),attributes:c.attributeIDs}}}if(!t.primitiveHashMap.size){const t=e.jsonDoc.json;t.extensionsUsed=(t.extensionsUsed||[]).filter(e=>e!==ne),t.extensionsRequired=(t.extensionsRequired||[]).filter(e=>e!==ne)}return this}}function ae(e,t){const s=[],r=e.getIndices();s.push(t.get(r));for(const r of e.listAttributes())s.push(t.get(r));return s.sort().join("|")}ie.EXTENSION_NAME=ne,ie.EncoderMethod=J;class ce extends e{constructor(...e){super(...e),this.propertyType="Light",this.parentTypes=[t.NODE],this.extensionName="KHR_lights_punctual",this._color=[1,1,1],this._intensity=1,this._type=ce.Type.POINT,this._range=null,this._innerConeAngle=0,this._outerConeAngle=Math.PI/4}copy(e,t=s){return super.copy(e,t),this._color=[...e._color],this._intensity=e._intensity,this._type=e._type,this._range=e._range,this._innerConeAngle=e._innerConeAngle,this._outerConeAngle=e._outerConeAngle,this}getColor(){return this._color}setColor(e){return this._color=e,this}getColorHex(){return x.factorToHex(this._color)}setColorHex(e){return x.hexToFactor(e,this._color),this}getIntensity(){return this._intensity}setIntensity(e){return this._intensity=e,this}getType(){return this._type}setType(e){return this._type=e,this}getRange(){return this._range}setRange(e){return this._range=e,this}getInnerConeAngle(){return this._innerConeAngle}setInnerConeAngle(e){return this._innerConeAngle=e,this}getOuterConeAngle(){return this._outerConeAngle}setOuterConeAngle(e){return this._outerConeAngle=e,this}}ce.EXTENSION_NAME="KHR_lights_punctual",ce.Type={POINT:"point",SPOT:"spot",DIRECTIONAL:"directional"};const ue="KHR_lights_punctual";class he extends o{constructor(...e){super(...e),this.extensionName=ue}createLight(){return new ce(this.doc.getGraph(),this)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[ue])return this;const s=(t.json.extensions[ue].lights||[]).map(e=>{const t=this.createLight().setName(e.name||"").setType(e.type);return void 0!==e.color&&t.setColor(e.color),void 0!==e.intensity&&t.setIntensity(e.intensity),void 0!==e.range&&t.setRange(e.range),void 0!==e.innerConeAngle&&t.setInnerConeAngle(e.innerConeAngle),void 0!==e.outerConeAngle&&t.setOuterConeAngle(e.outerConeAngle),t});return t.json.nodes.forEach((t,r)=>{t.extensions&&t.extensions[ue]&&e.nodes[r].setExtension(ue,s[t.extensions[ue].light])}),this}write(e){const t=e.jsonDoc;if(0===this.properties.size)return this;const s=[],r=new Map;for(const e of this.properties){const t=e,o={type:t.getType()};l.eq(t.getColor(),[1,1,1])||(o.color=t.getColor()),1!==t.getIntensity()&&(o.intensity=t.getIntensity()),null!=t.getRange()&&(o.range=t.getRange()),t.getName()&&(o.name=t.getName()),t.getType()===ce.Type.SPOT&&(o.innerConeAngle=t.getInnerConeAngle(),o.outerConeAngle=t.getOuterConeAngle()),s.push(o),r.set(t,s.length-1)}return this.doc.getRoot().listNodes().forEach(s=>{const o=s.getExtension(ue);if(o){const n=e.nodeIndexMap.get(s),i=t.json.nodes[n];i.extensions=i.extensions||{},i.extensions[ue]={light:r.get(o)}}}),t.json.extensions=t.json.extensions||{},t.json.extensions[ue]={lights:s},this}}he.EXTENSION_NAME=ue;const{R:le,G:pe,B:fe}=m;class de extends e{constructor(...e){super(...e),this.propertyType="Clearcoat",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_clearcoat",this._clearcoatFactor=0,this._clearcoatRoughnessFactor=0,this._clearcoatNormalScale=1,this.clearcoatTexture=null,this.clearcoatTextureInfo=this.graph.link("clearcoatTextureInfo",this,new T(this.graph)),this.clearcoatRoughnessTexture=null,this.clearcoatRoughnessTextureInfo=this.graph.link("clearcoatRoughnessTextureInfo",this,new T(this.graph)),this.clearcoatNormalTexture=null,this.clearcoatNormalTextureInfo=this.graph.link("clearcoatNormalTextureInfo",this,new T(this.graph))}copy(e,t=s){return super.copy(e,t),this._clearcoatFactor=e._clearcoatFactor,this._clearcoatRoughnessFactor=e._clearcoatRoughnessFactor,this._clearcoatNormalScale=e._clearcoatNormalScale,this.setClearcoatTexture(e.clearcoatTexture?t(e.clearcoatTexture.getChild()):null),this.clearcoatTextureInfo.getChild().copy(t(e.clearcoatTextureInfo.getChild()),t),this.setClearcoatRoughnessTexture(e.clearcoatRoughnessTexture?t(e.clearcoatRoughnessTexture.getChild()):null),this.clearcoatRoughnessTextureInfo.getChild().copy(t(e.clearcoatRoughnessTextureInfo.getChild()),t),this.setClearcoatNormalTexture(e.clearcoatNormalTexture?t(e.clearcoatNormalTexture.getChild()):null),this.clearcoatNormalTextureInfo.getChild().copy(t(e.clearcoatNormalTextureInfo.getChild()),t),this}dispose(){this.clearcoatTextureInfo.getChild().dispose(),this.clearcoatRoughnessTextureInfo.getChild().dispose(),this.clearcoatNormalTextureInfo.getChild().dispose(),super.dispose()}getClearcoatFactor(){return this._clearcoatFactor}setClearcoatFactor(e){return this._clearcoatFactor=e,this}getClearcoatTexture(){return this.clearcoatTexture?this.clearcoatTexture.getChild():null}getClearcoatTextureInfo(){return this.clearcoatTexture?this.clearcoatTextureInfo.getChild():null}setClearcoatTexture(e){return this.clearcoatTexture=this.graph.linkTexture("clearcoatTexture",le,this,e),this}getClearcoatRoughnessFactor(){return this._clearcoatRoughnessFactor}setClearcoatRoughnessFactor(e){return this._clearcoatRoughnessFactor=e,this}getClearcoatRoughnessTexture(){return this.clearcoatRoughnessTexture?this.clearcoatRoughnessTexture.getChild():null}getClearcoatRoughnessTextureInfo(){return this.clearcoatRoughnessTexture?this.clearcoatRoughnessTextureInfo.getChild():null}setClearcoatRoughnessTexture(e){return this.clearcoatRoughnessTexture=this.graph.linkTexture("clearcoatRoughnessTexture",pe,this,e),this}getClearcoatNormalScale(){return this._clearcoatNormalScale}setClearcoatNormalScale(e){return this._clearcoatNormalScale=e,this}getClearcoatNormalTexture(){return this.clearcoatNormalTexture?this.clearcoatNormalTexture.getChild():null}getClearcoatNormalTextureInfo(){return this.clearcoatNormalTexture?this.clearcoatNormalTextureInfo.getChild():null}setClearcoatNormalTexture(e){return this.clearcoatNormalTexture=this.graph.linkTexture("clearcoatNormalTexture",le|pe|fe,this,e),this}}de.EXTENSION_NAME="KHR_materials_clearcoat",C([g],de.prototype,"clearcoatTexture",void 0),C([g],de.prototype,"clearcoatTextureInfo",void 0),C([g],de.prototype,"clearcoatRoughnessTexture",void 0),C([g],de.prototype,"clearcoatRoughnessTextureInfo",void 0),C([g],de.prototype,"clearcoatNormalTexture",void 0),C([g],de.prototype,"clearcoatNormalTextureInfo",void 0);const xe="KHR_materials_clearcoat";class Te extends o{constructor(...e){super(...e),this.extensionName=xe}createClearcoat(){return new de(this.doc.getGraph(),this)}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((t,r)=>{if(t.extensions&&t.extensions[xe]){const o=this.createClearcoat();e.materials[r].setExtension(xe,o);const n=t.extensions[xe];if(void 0!==n.clearcoatFactor&&o.setClearcoatFactor(n.clearcoatFactor),void 0!==n.clearcoatRoughnessFactor&&o.setClearcoatRoughnessFactor(n.clearcoatRoughnessFactor),void 0!==n.clearcoatTexture){const t=n.clearcoatTexture;o.setClearcoatTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getClearcoatTextureInfo(),t)}if(void 0!==n.clearcoatRoughnessTexture){const t=n.clearcoatRoughnessTexture;o.setClearcoatRoughnessTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getClearcoatRoughnessTextureInfo(),t)}if(void 0!==n.clearcoatNormalTexture){const t=n.clearcoatNormalTexture;o.setClearcoatNormalTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getClearcoatNormalTextureInfo(),t),void 0!==t.scale&&o.setClearcoatNormalScale(t.scale)}}}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(xe);if(r){const o=e.materialIndexMap.get(s),n=t.json.materials[o];n.extensions=n.extensions||{};const i=n.extensions[xe]={clearcoatFactor:r.getClearcoatFactor(),clearcoatRoughnessFactor:r.getClearcoatRoughnessFactor()};if(r.getClearcoatTexture()){const t=r.getClearcoatTexture(),s=r.getClearcoatTextureInfo();i.clearcoatTexture=e.createTextureInfoDef(t,s)}if(r.getClearcoatRoughnessTexture()){const t=r.getClearcoatRoughnessTexture(),s=r.getClearcoatRoughnessTextureInfo();i.clearcoatRoughnessTexture=e.createTextureInfoDef(t,s)}if(r.getClearcoatNormalTexture()){const t=r.getClearcoatNormalTexture(),s=r.getClearcoatNormalTextureInfo();i.clearcoatNormalTexture=e.createTextureInfoDef(t,s),1!==r.getClearcoatNormalScale()&&(i.clearcoatNormalTexture.scale=r.getClearcoatNormalScale())}}}),this}}Te.EXTENSION_NAME=xe;class ge extends e{constructor(...e){super(...e),this.propertyType="IOR",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_ior",this._ior=0}copy(e,t=s){return super.copy(e,t),this._ior=e._ior,this}getIOR(){return this._ior}setIOR(e){return this._ior=e,this}}ge.EXTENSION_NAME="KHR_materials_ior";const me="KHR_materials_ior";class _e extends o{constructor(...e){super(...e),this.extensionName=me}createIOR(){return new ge(this.doc.getGraph(),this)}read(e){return(e.jsonDoc.json.materials||[]).forEach((t,s)=>{if(t.extensions&&t.extensions[me]){const r=this.createIOR();e.materials[s].setExtension(me,r);const o=t.extensions[me];void 0!==o.ior&&r.setIOR(o.ior)}}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(me);if(r){const o=e.materialIndexMap.get(s),n=t.json.materials[o];n.extensions=n.extensions||{},n.extensions[me]={ior:r.getIOR()}}}),this}}_e.EXTENSION_NAME=me;const{R:Ee,G:Ce,B:Ie,A:ye}=m;class Ne extends e{constructor(...e){super(...e),this.propertyType="PBRSpecularGlossiness",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_pbrSpecularGlossiness",this._diffuseFactor=[1,1,1,1],this._specularFactor=[1,1,1],this._glossinessFactor=1,this.diffuseTexture=null,this.diffuseTextureInfo=this.graph.link("diffuseTextureInfo",this,new T(this.graph)),this.specularGlossinessTexture=null,this.specularGlossinessTextureInfo=this.graph.link("specularGlossinessTextureInfo",this,new T(this.graph))}copy(e,t=s){return super.copy(e,t),this._diffuseFactor=e._diffuseFactor,this._specularFactor=e._specularFactor,this._glossinessFactor=e._glossinessFactor,this.setDiffuseTexture(e.diffuseTexture?t(e.diffuseTexture.getChild()):null),this.diffuseTextureInfo.getChild().copy(t(e.diffuseTextureInfo.getChild()),t),this.setSpecularGlossinessTexture(e.specularGlossinessTexture?t(e.specularGlossinessTexture.getChild()):null),this.specularGlossinessTextureInfo.getChild().copy(t(e.specularGlossinessTextureInfo.getChild()),t),this}dispose(){this.diffuseTextureInfo.getChild().dispose(),this.specularGlossinessTextureInfo.getChild().dispose(),super.dispose()}getDiffuseFactor(){return this._diffuseFactor}setDiffuseFactor(e){return this._diffuseFactor=e,this}getDiffuseHex(){return x.factorToHex(this._diffuseFactor)}setDiffuseHex(e){return x.hexToFactor(e,this._diffuseFactor),this}getDiffuseTexture(){return this.diffuseTexture?this.diffuseTexture.getChild():null}getDiffuseTextureInfo(){return this.diffuseTexture?this.diffuseTextureInfo.getChild():null}setDiffuseTexture(e){return this.diffuseTexture=this.graph.linkTexture("diffuseTexture",Ee|Ce|Ie|ye,this,e),this}getSpecularFactor(){return this._specularFactor}setSpecularFactor(e){return this._specularFactor=e,this}getGlossinessFactor(){return this._glossinessFactor}setGlossinessFactor(e){return this._glossinessFactor=e,this}getSpecularGlossinessTexture(){return this.specularGlossinessTexture?this.specularGlossinessTexture.getChild():null}getSpecularGlossinessTextureInfo(){return this.specularGlossinessTexture?this.specularGlossinessTextureInfo.getChild():null}setSpecularGlossinessTexture(e){return this.specularGlossinessTexture=this.graph.linkTexture("specularGlossinessTexture",Ee|Ce|Ie|ye,this,e),this}}Ne.EXTENSION_NAME="KHR_materials_pbrSpecularGlossiness",C([g],Ne.prototype,"diffuseTexture",void 0),C([g],Ne.prototype,"diffuseTextureInfo",void 0),C([g],Ne.prototype,"specularGlossinessTexture",void 0),C([g],Ne.prototype,"specularGlossinessTextureInfo",void 0);const Re="KHR_materials_pbrSpecularGlossiness";class Ae extends o{constructor(...e){super(...e),this.extensionName=Re}createPBRSpecularGlossiness(){return new Ne(this.doc.getGraph(),this)}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((t,r)=>{if(t.extensions&&t.extensions[Re]){const o=this.createPBRSpecularGlossiness();e.materials[r].setExtension(Re,o);const n=t.extensions[Re];if(void 0!==n.diffuseFactor&&o.setDiffuseFactor(n.diffuseFactor),void 0!==n.specularFactor&&o.setSpecularFactor(n.specularFactor),void 0!==n.glossinessFactor&&o.setGlossinessFactor(n.glossinessFactor),void 0!==n.diffuseTexture){const t=n.diffuseTexture;o.setDiffuseTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getDiffuseTextureInfo(),t)}if(void 0!==n.specularGlossinessTexture){const t=n.specularGlossinessTexture;o.setSpecularGlossinessTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getSpecularGlossinessTextureInfo(),t)}}}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Re);if(r){const o=e.materialIndexMap.get(s),n=t.json.materials[o];n.extensions=n.extensions||{};const i=n.extensions[Re]={diffuseFactor:r.getDiffuseFactor(),specularFactor:r.getSpecularFactor(),glossinessFactor:r.getGlossinessFactor()};if(r.getDiffuseTexture()){const t=r.getDiffuseTexture(),s=r.getDiffuseTextureInfo();i.diffuseTexture=e.createTextureInfoDef(t,s)}if(r.getSpecularGlossinessTexture()){const t=r.getSpecularGlossinessTexture(),s=r.getSpecularGlossinessTextureInfo();i.specularGlossinessTexture=e.createTextureInfoDef(t,s)}}}),this}}Ae.EXTENSION_NAME=Re;const{R:Se,G:Fe,B:we,A:Oe}=m;class Me extends e{constructor(...e){super(...e),this.propertyType="Sheen",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_sheen",this._sheenColorFactor=[0,0,0],this._sheenRoughnessFactor=0,this.sheenColorTexture=null,this.sheenColorTextureInfo=this.graph.link("sheenColorTextureInfo",this,new T(this.graph)),this.sheenRoughnessTexture=null,this.sheenRoughnessTextureInfo=this.graph.link("sheenRoughnessTextureInfo",this,new T(this.graph))}copy(e,t=s){return super.copy(e,t),this._sheenColorFactor=e._sheenColorFactor,this._sheenRoughnessFactor=e._sheenRoughnessFactor,this.setSheenColorTexture(e.sheenColorTexture?t(e.sheenColorTexture.getChild()):null),this.sheenColorTextureInfo.getChild().copy(t(e.sheenColorTextureInfo.getChild()),t),this.setSheenRoughnessTexture(e.sheenRoughnessTexture?t(e.sheenRoughnessTexture.getChild()):null),this.sheenRoughnessTextureInfo.getChild().copy(t(e.sheenRoughnessTextureInfo.getChild()),t),this}dispose(){this.sheenColorTextureInfo.getChild().dispose(),this.sheenRoughnessTextureInfo.getChild().dispose(),super.dispose()}getSheenColorFactor(){return this._sheenColorFactor}getSheenColorHex(){return x.factorToHex(this._sheenColorFactor)}setSheenColorFactor(e){return this._sheenColorFactor=e,this}setSheenColorHex(e){return x.hexToFactor(e,this._sheenColorFactor),this}getSheenColorTexture(){return this.sheenColorTexture?this.sheenColorTexture.getChild():null}getSheenColorTextureInfo(){return this.sheenColorTexture?this.sheenColorTextureInfo.getChild():null}setSheenColorTexture(e){return this.sheenColorTexture=this.graph.linkTexture("sheenColorTexture",Se|Fe|we,this,e),this}getSheenRoughnessFactor(){return this._sheenRoughnessFactor}setSheenRoughnessFactor(e){return this._sheenRoughnessFactor=e,this}getSheenRoughnessTexture(){return this.sheenRoughnessTexture?this.sheenRoughnessTexture.getChild():null}getSheenRoughnessTextureInfo(){return this.sheenRoughnessTexture?this.sheenRoughnessTextureInfo.getChild():null}setSheenRoughnessTexture(e){return this.sheenRoughnessTexture=this.graph.linkTexture("sheenRoughnessTexture",Oe,this,e),this}}Me.EXTENSION_NAME="KHR_materials_sheen",C([g],Me.prototype,"sheenColorTexture",void 0),C([g],Me.prototype,"sheenColorTextureInfo",void 0),C([g],Me.prototype,"sheenRoughnessTexture",void 0),C([g],Me.prototype,"sheenRoughnessTextureInfo",void 0);const be="KHR_materials_sheen";class De extends o{constructor(...e){super(...e),this.extensionName=be}createSheen(){return new Me(this.doc.getGraph(),this)}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((t,r)=>{if(t.extensions&&t.extensions[be]){const o=this.createSheen();e.materials[r].setExtension(be,o);const n=t.extensions[be];if(void 0!==n.sheenColorFactor&&o.setSheenColorFactor(n.sheenColorFactor),void 0!==n.sheenRoughnessFactor&&o.setSheenRoughnessFactor(n.sheenRoughnessFactor),void 0!==n.sheenColorTexture){const t=n.sheenColorTexture;o.setSheenColorTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getSheenColorTextureInfo(),t)}if(void 0!==n.sheenRoughnessTexture){const t=n.sheenRoughnessTexture;o.setSheenRoughnessTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getSheenRoughnessTextureInfo(),t)}}}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(be);if(r){const o=e.materialIndexMap.get(s),n=t.json.materials[o];n.extensions=n.extensions||{};const i=n.extensions[be]={sheenColorFactor:r.getSheenColorFactor(),sheenRoughnessFactor:r.getSheenRoughnessFactor()};if(r.getSheenColorTexture()){const t=r.getSheenColorTexture(),s=r.getSheenColorTextureInfo();i.sheenColorTexture=e.createTextureInfoDef(t,s)}if(r.getSheenRoughnessTexture()){const t=r.getSheenRoughnessTexture(),s=r.getSheenRoughnessTextureInfo();i.sheenRoughnessTexture=e.createTextureInfoDef(t,s)}}}),this}}De.EXTENSION_NAME=be;const{R:ve,G:Ge,B:je,A:Be}=m;class ke extends e{constructor(...e){super(...e),this.propertyType="Specular",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_specular",this._specularFactor=1,this._specularColorFactor=[1,1,1],this.specularTexture=null,this.specularTextureInfo=this.graph.link("specularTextureInfo",this,new T(this.graph)),this.specularColorTexture=null,this.specularColorTextureInfo=this.graph.link("specularColorTextureInfo",this,new T(this.graph))}copy(e,t=s){return super.copy(e,t),this._specularFactor=e._specularFactor,this._specularColorFactor=e._specularColorFactor,this.setSpecularTexture(e.specularTexture?t(e.specularTexture.getChild()):null),this.specularTextureInfo.getChild().copy(t(e.specularTextureInfo.getChild()),t),this.setSpecularColorTexture(e.specularColorTexture?t(e.specularColorTexture.getChild()):null),this.specularColorTextureInfo.getChild().copy(t(e.specularColorTextureInfo.getChild()),t),this}dispose(){this.specularTextureInfo.getChild().dispose(),super.dispose()}getSpecularFactor(){return this._specularFactor}setSpecularFactor(e){return this._specularFactor=e,this}getSpecularColorFactor(){return this._specularColorFactor}setSpecularColorFactor(e){return this._specularColorFactor=e,this}getSpecularColorHex(){return x.factorToHex(this._specularColorFactor)}setSpecularColorHex(e){return x.hexToFactor(e,this._specularColorFactor),this}getSpecularTexture(){return this.specularTexture?this.specularTexture.getChild():null}getSpecularTextureInfo(){return this.specularTexture?this.specularTextureInfo.getChild():null}setSpecularTexture(e){return this.specularTexture=this.graph.linkTexture("specularTexture",Be,this,e),this}getSpecularColorTexture(){return this.specularColorTexture?this.specularColorTexture.getChild():null}getSpecularColorTextureInfo(){return this.specularColorTexture?this.specularColorTextureInfo.getChild():null}setSpecularColorTexture(e){return this.specularColorTexture=this.graph.linkTexture("specularColorTexture",ve|Ge|je,this,e),this}}ke.EXTENSION_NAME="KHR_materials_specular",C([g],ke.prototype,"specularTexture",void 0),C([g],ke.prototype,"specularTextureInfo",void 0),C([g],ke.prototype,"specularColorTexture",void 0),C([g],ke.prototype,"specularColorTextureInfo",void 0);const Le="KHR_materials_specular";class Ue extends o{constructor(...e){super(...e),this.extensionName=Le}createSpecular(){return new ke(this.doc.getGraph(),this)}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((t,r)=>{if(t.extensions&&t.extensions[Le]){const o=this.createSpecular();e.materials[r].setExtension(Le,o);const n=t.extensions[Le];if(void 0!==n.specularFactor&&o.setSpecularFactor(n.specularFactor),void 0!==n.specularColorFactor&&o.setSpecularColorFactor(n.specularColorFactor),void 0!==n.specularTexture){const t=n.specularTexture;o.setSpecularTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getSpecularTextureInfo(),t)}if(void 0!==n.specularColorTexture){const t=n.specularColorTexture;o.setSpecularColorTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getSpecularColorTextureInfo(),t)}}}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Le);if(r){const o=e.materialIndexMap.get(s),n=t.json.materials[o];n.extensions=n.extensions||{};const i=n.extensions[Le]={};if(1!==r.getSpecularFactor()&&(i.specularFactor=r.getSpecularFactor()),l.eq(r.getSpecularColorFactor(),[1,1,1])||(i.specularColorFactor=r.getSpecularColorFactor()),r.getSpecularTexture()){const t=r.getSpecularTexture(),s=r.getSpecularTextureInfo();i.specularTexture=e.createTextureInfoDef(t,s)}if(r.getSpecularColorTexture()){const t=r.getSpecularColorTexture(),s=r.getSpecularColorTextureInfo();i.specularColorTexture=e.createTextureInfoDef(t,s)}}}),this}}Ue.EXTENSION_NAME=Le;const{R:He}=m;class Ve extends e{constructor(...e){super(...e),this.propertyType="Transmission",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_transmission",this._transmissionFactor=0,this.transmissionTexture=null,this.transmissionTextureInfo=this.graph.link("transmissionTextureInfo",this,new T(this.graph))}copy(e,t=s){return super.copy(e,t),this._transmissionFactor=e._transmissionFactor,this.setTransmissionTexture(e.transmissionTexture?t(e.transmissionTexture.getChild()):null),this.transmissionTextureInfo.getChild().copy(t(e.transmissionTextureInfo.getChild()),t),this}dispose(){this.transmissionTextureInfo.getChild().dispose(),super.dispose()}getTransmissionFactor(){return this._transmissionFactor}setTransmissionFactor(e){return this._transmissionFactor=e,this}getTransmissionTexture(){return this.transmissionTexture?this.transmissionTexture.getChild():null}getTransmissionTextureInfo(){return this.transmissionTexture?this.transmissionTextureInfo.getChild():null}setTransmissionTexture(e){return this.transmissionTexture=this.graph.linkTexture("transmissionTexture",He,this,e),this}}Ve.EXTENSION_NAME="KHR_materials_transmission",C([g],Ve.prototype,"transmissionTexture",void 0),C([g],Ve.prototype,"transmissionTextureInfo",void 0);const Pe="KHR_materials_transmission";class Xe extends o{constructor(...e){super(...e),this.extensionName=Pe}createTransmission(){return new Ve(this.doc.getGraph(),this)}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((t,r)=>{if(t.extensions&&t.extensions[Pe]){const o=this.createTransmission();e.materials[r].setExtension(Pe,o);const n=t.extensions[Pe];if(void 0!==n.transmissionFactor&&o.setTransmissionFactor(n.transmissionFactor),void 0!==n.transmissionTexture){const t=n.transmissionTexture;o.setTransmissionTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getTransmissionTextureInfo(),t)}}}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(Pe);if(r){const o=e.materialIndexMap.get(s),n=t.json.materials[o];n.extensions=n.extensions||{};const i=n.extensions[Pe]={transmissionFactor:r.getTransmissionFactor()};if(r.getTransmissionTexture()){const t=r.getTransmissionTexture(),s=r.getTransmissionTextureInfo();i.transmissionTexture=e.createTextureInfoDef(t,s)}}}),this}}Xe.EXTENSION_NAME=Pe;class Ke extends e{constructor(...e){super(...e),this.propertyType="Unlit",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_unlit"}}Ke.EXTENSION_NAME="KHR_materials_unlit";const ze="KHR_materials_unlit";class qe extends o{constructor(...e){super(...e),this.extensionName=ze}createUnlit(){return new Ke(this.doc.getGraph(),this)}read(e){return(e.jsonDoc.json.materials||[]).forEach((t,s)=>{t.extensions&&t.extensions[ze]&&e.materials[s].setExtension(ze,this.createUnlit())}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{if(s.getExtension(ze)){const r=e.materialIndexMap.get(s),o=t.json.materials[r];o.extensions=o.extensions||{},o.extensions[ze]={}}}),this}}qe.EXTENSION_NAME=ze;class $e extends e{constructor(...e){super(...e),this.propertyType="Mapping",this.parentTypes=["MappingList"],this.extensionName="KHR_materials_variants",this.material=null,this.variants=[]}copy(e,t=s){return super.copy(e,t),this.setMaterial(e.material?t(e.material.getChild()):null),this.clearGraphChildList(this.variants),e.variants.forEach(e=>this.addVariant(t(e.getChild()))),this}getMaterial(){return this.material?this.material.getChild():null}setMaterial(e){return this.material=this.graph.link("material",this,e),this}addVariant(e){const t=this.graph.link("variant",this,e);return this.addGraphChild(this.variants,t)}removeVariant(e){return this.removeGraphChild(this.variants,e)}listVariants(){return this.variants.map(e=>e.getChild())}}$e.EXTENSION_NAME="KHR_materials_variants",C([g],$e.prototype,"material",void 0),C([r],$e.prototype,"variants",void 0);class Ye extends e{constructor(...e){super(...e),this.propertyType="MappingList",this.parentTypes=[t.PRIMITIVE],this.extensionName="KHR_materials_variants",this.mappings=[]}copy(e,t=s){return super.copy(e,t),this.clearGraphChildList(this.mappings),e.mappings.forEach(e=>this.addMapping(t(e.getChild()))),this}addMapping(e){const t=this.graph.link("mapping",this,e);return this.addGraphChild(this.mappings,t)}removeMapping(e){return this.removeGraphChild(this.mappings,e)}listMappings(){return this.mappings.map(e=>e.getChild())}}Ye.EXTENSION_NAME="KHR_materials_variants",C([r],Ye.prototype,"mappings",void 0);class Qe extends e{constructor(...e){super(...e),this.propertyType="Variant",this.parentTypes=[t.ROOT,"MappingList"],this.extensionName="KHR_materials_variants"}}Qe.EXTENSION_NAME="KHR_materials_variants";const We="KHR_materials_variants";class Je extends o{constructor(...e){super(...e),this.extensionName=We}createMappingList(){return new Ye(this.doc.getGraph(),this)}createVariant(e=""){return new Qe(this.doc.getGraph(),this).setName(e)}createMapping(){return new $e(this.doc.getGraph(),this)}listVariants(){return Array.from(this.properties).filter(e=>e instanceof Qe)}read(e){const t=e.jsonDoc;if(!t.json.extensions||!t.json.extensions[We])return this;const s=(t.json.extensions[We].variants||[]).map(e=>this.createVariant().setName(e.name||""));return(t.json.meshes||[]).forEach((t,r)=>{const o=e.meshes[r];(t.primitives||[]).forEach((t,r)=>{if(!t.extensions||!t.extensions[We])return;const n=this.createMappingList(),i=t.extensions[We];for(const t of i.mappings){const r=this.createMapping();void 0!==t.material&&r.setMaterial(e.materials[t.material]);for(const e of t.variants||[])r.addVariant(s[e]);n.addMapping(r)}o.listPrimitives()[r].setExtension(We,n)})}),this}write(e){const t=e.jsonDoc,s=this.listVariants();if(!s.length)return this;const r=[],o=new Map;for(const t of s)o.set(t,r.length),r.push(e.createPropertyDef(t));for(const t of this.doc.getRoot().listMeshes()){const s=e.meshIndexMap.get(t);t.listPrimitives().forEach((t,r)=>{const n=t.getExtension(We);if(!n)return;const i=e.jsonDoc.json.meshes[s].primitives[r],a=n.listMappings().map(t=>{const s=e.createPropertyDef(t),r=t.getMaterial();return r&&(s.material=e.materialIndexMap.get(r)),s.variants=t.listVariants().map(e=>o.get(e)),s});i.extensions=i.extensions||{},i.extensions[We]={mappings:a}})}return t.json.extensions=t.json.extensions||{},t.json.extensions[We]={variants:r},this}}Je.EXTENSION_NAME=We;const{G:Ze}=m;class et extends e{constructor(...e){super(...e),this.propertyType="Transmission",this.parentTypes=[t.MATERIAL],this.extensionName="KHR_materials_volume",this._thicknessFactor=0,this._attenuationDistance=Infinity,this._attenuationColor=[1,1,1],this.thicknessTexture=null,this.thicknessTextureInfo=this.graph.link("thicknessTextureInfo",this,new T(this.graph))}copy(e,t=s){return super.copy(e,t),this._thicknessFactor=e._thicknessFactor,this._attenuationDistance=e._attenuationDistance,this._attenuationColor=[...e._attenuationColor],this.setThicknessTexture(e.thicknessTexture?t(e.thicknessTexture.getChild()):null),this.thicknessTextureInfo.getChild().copy(t(e.thicknessTextureInfo.getChild()),t),this}dispose(){this.thicknessTextureInfo.getChild().dispose(),super.dispose()}getThicknessFactor(){return this._thicknessFactor}setThicknessFactor(e){return this._thicknessFactor=e,this}getThicknessTexture(){return this.thicknessTexture?this.thicknessTexture.getChild():null}getThicknessTextureInfo(){return this.thicknessTexture?this.thicknessTextureInfo.getChild():null}setThicknessTexture(e){return this.thicknessTexture=this.graph.linkTexture("thicknessTexture",Ze,this,e),this}getAttenuationDistance(){return this._attenuationDistance}setAttenuationDistance(e){return this._attenuationDistance=e,this}getAttenuationColor(){return this._attenuationColor}setAttenuationColor(e){return this._attenuationColor=e,this}getAttenuationColorHex(){return x.factorToHex(this._attenuationColor)}setAttenuationColorHex(e){return x.hexToFactor(e,this._attenuationColor),this}}et.EXTENSION_NAME="KHR_materials_volume",C([g],et.prototype,"thicknessTexture",void 0),C([g],et.prototype,"thicknessTextureInfo",void 0);const tt="KHR_materials_volume";class st extends o{constructor(...e){super(...e),this.extensionName=tt}createVolume(){return new et(this.doc.getGraph(),this)}read(e){const t=e.jsonDoc,s=t.json.textures||[];return(t.json.materials||[]).forEach((t,r)=>{if(t.extensions&&t.extensions[tt]){const o=this.createVolume();e.materials[r].setExtension(tt,o);const n=t.extensions[tt];if(void 0!==n.thicknessFactor&&o.setThicknessFactor(n.thicknessFactor),void 0!==n.attenuationDistance&&o.setAttenuationDistance(n.attenuationDistance),void 0!==n.attenuationColor&&o.setAttenuationColor(n.attenuationColor),void 0!==n.thicknessTexture){const t=n.thicknessTexture;o.setThicknessTexture(e.textures[s[t.index].source]),e.setTextureInfo(o.getThicknessTextureInfo(),t)}}}),this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(s=>{const r=s.getExtension(tt);if(r){const o=e.materialIndexMap.get(s),n=t.json.materials[o];n.extensions=n.extensions||{};const i=n.extensions[tt]={};if(r.getThicknessFactor()>0&&(i.thicknessFactor=r.getThicknessFactor()),Number.isFinite(r.getAttenuationDistance())&&(i.attenuationDistance=r.getAttenuationDistance()),l.eq(r.getAttenuationColor(),[1,1,1])||(i.attenuationColor=r.getAttenuationColor()),r.getThicknessTexture()){const t=r.getThicknessTexture(),s=r.getThicknessTextureInfo();i.thicknessTexture=e.createTextureInfoDef(t,s)}}}),this}}st.EXTENSION_NAME=tt;const rt="KHR_mesh_quantization";class ot extends o{constructor(...e){super(...e),this.extensionName=rt}read(e){return this}write(e){return this}}ot.EXTENSION_NAME=rt;const nt="KHR_texture_basisu";class it{getSize(e){const t=_(new Uint8Array(e));return[t.pixelWidth,t.pixelHeight]}getChannels(e){const t=_(new Uint8Array(e)).dataFormatDescriptor[0];if(t.colorModel===E.ETC1S)return 2===t.samples.length&&15==(15&t.samples[1].channelID)?4:3;if(t.colorModel===E.UASTC)return 3==(15&t.samples[0].channelID)?4:3;throw new Error(`Unexpected KTX2 colorModel, "${t.colorModel}".`)}getGPUByteLength(e){const t=_(new Uint8Array(e)),s=this.getChannels(e)>3;let r=0;for(let e=0;e<t.levels.length;e++){const o=t.levels[e];r+=o.uncompressedByteLength?o.uncompressedByteLength:Math.max(1,Math.floor(t.pixelWidth/Math.pow(2,e)))/4*(Math.max(1,Math.floor(t.pixelHeight/Math.pow(2,e)))/4)*(s?16:8)}return r}}class at extends o{constructor(...e){super(...e),this.extensionName=nt,this.prereadTypes=[t.TEXTURE]}static register(){f.registerFormat("image/ktx2",new it)}preread(e){return e.jsonDoc.json.textures.forEach(e=>{e.extensions&&e.extensions[nt]&&(e.source=e.extensions[nt].source)}),this}read(e){return this}write(e){const t=e.jsonDoc;return this.doc.getRoot().listTextures().forEach(s=>{if("image/ktx2"===s.getMimeType()){const r=e.imageIndexMap.get(s);t.json.textures.forEach(e=>{e.source===r&&(e.extensions=e.extensions||{},e.extensions[nt]={source:e.source},delete e.source)})}}),this}}at.EXTENSION_NAME=nt;class ct extends e{constructor(...e){super(...e),this.propertyType="Transform",this.parentTypes=[t.TEXTURE_INFO],this.extensionName="KHR_texture_transform",this._offset=[0,0],this._rotation=0,this._scale=[1,1],this._texCoord=null}copy(e,t=s){return super.copy(e,t),this._offset=e._offset,this._rotation=e._rotation,this._scale=e._scale,this._texCoord=e._texCoord,this}getOffset(){return this._offset}setOffset(e){return this._offset=e,this}getRotation(){return this._rotation}setRotation(e){return this._rotation=e,this}getScale(){return this._scale}setScale(e){return this._scale=e,this}getTexCoord(){return this._texCoord}setTexCoord(e){return this._texCoord=e,this}}ct.EXTENSION_NAME="KHR_texture_transform";const ut="KHR_texture_transform";class ht extends o{constructor(...e){super(...e),this.extensionName=ut}createTransform(){return new ct(this.doc.getGraph(),this)}read(e){for(const[t,s]of Array.from(e.textureInfos.entries())){if(!s.extensions||!s.extensions[ut])continue;const e=this.createTransform(),r=s.extensions[ut];void 0!==r.offset&&e.setOffset(r.offset),void 0!==r.rotation&&e.setRotation(r.rotation),void 0!==r.scale&&e.setScale(r.scale),void 0!==r.texCoord&&e.setTexCoord(r.texCoord),t.setExtension(ut,e)}return this}write(e){const t=Array.from(e.textureInfoDefMap.entries());for(const[e,s]of t){const t=e.getExtension(ut);if(!t)continue;s.extensions=s.extensions||{};const r={},o=l.eq;o(t.getOffset(),[0,0])||(r.offset=t.getOffset()),0!==t.getRotation()&&(r.rotation=t.getRotation()),o(t.getScale(),[1,1])||(r.scale=t.getScale()),null!=t.getTexCoord()&&(r.texCoord=t.getTexCoord()),s.extensions[ut]=r}return this}}ht.EXTENSION_NAME=ut;const lt=[ie,he,Te,_e,Ae,Ue,De,Xe,qe,Je,st,ot,at,ht],pt=[N,U,P,...lt];export{pt as ALL_EXTENSIONS,de as Clearcoat,ie as DracoMeshCompression,ge as IOR,I as InstancedMesh,lt as KHRONOS_EXTENSIONS,ce as Light,he as LightsPunctual,$e as Mapping,Ye as MappingList,Te as MaterialsClearcoat,_e as MaterialsIOR,Ae as MaterialsPBRSpecularGlossiness,De as MaterialsSheen,Ue as MaterialsSpecular,Xe as MaterialsTransmission,qe as MaterialsUnlit,Je as MaterialsVariants,st as MaterialsVolume,N as MeshGPUInstancing,ot as MeshQuantization,U as MeshoptCompression,Ne as PBRSpecularGlossiness,Me as Sheen,ke as Specular,at as TextureBasisu,ht as TextureTransform,P as TextureWebP,ct as Transform,Ve as Transmission,Ke as Unlit,Qe as Variant,et as Volume};
//# sourceMappingURL=extensions.modern.js.map
