var e=require("@gltf-transform/core"),t=require("ktx-parse");function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function n(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,o(e,t)}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function s(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function a(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return i(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?i(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(r=e[Symbol.iterator]()).next.bind(r)}function u(e,t,r,n){var o,s=arguments.length,i=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(i=(s<3?o(i):s>3?o(t,r,i):o(t,r))||i);return s>3&&i&&Object.defineProperty(t,r,i),i}var c=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return(r=t.call.apply(t,[this].concat(o))||this).propertyType="InstancedMesh",r.parentTypes=[e.PropertyType.NODE],r.extensionName="EXT_mesh_gpu_instancing",r.attributes=[],r}n(r,t);var o=r.prototype;return o.copy=function(r,n){var o=this;return void 0===n&&(n=e.COPY_IDENTITY),t.prototype.copy.call(this,r,n),this.clearGraphChildList(this.attributes),r.listSemantics().forEach(function(e){o.setAttribute(e,n(r.getAttribute(e)))}),this},o.getAttribute=function(e){var t=this.attributes.find(function(t){return t.semantic===e});return t?t.getChild():null},o.setAttribute=function(e,t){var r=this.getAttribute(e);if(r&&this.removeGraphChild(this.attributes,r),!t)return this;var n=this.graph.linkAttribute(e.toLowerCase(),this,t);return n.semantic=e,this.addGraphChild(this.attributes,n)},o.listAttributes=function(){return this.attributes.map(function(e){return e.getChild()})},o.listSemantics=function(){return this.attributes.map(function(e){return e.semantic})},r}(e.ExtensionProperty);c.EXTENSION_NAME="EXT_mesh_gpu_instancing",u([e.GraphChildList],c.prototype,"attributes",void 0);var l,h,f,p="EXT_mesh_gpu_instancing",T=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return(r=t.call.apply(t,[this].concat(o))||this).extensionName=p,r.provideTypes=[e.PropertyType.NODE],r.prewriteTypes=[e.PropertyType.ACCESSOR],r}n(r,t);var o=r.prototype;return o.createInstancedMesh=function(){return new c(this.doc.getGraph(),this)},o.read=function(e){var t=this;return(e.jsonDoc.json.nodes||[]).forEach(function(r,n){if(r.extensions&&r.extensions[p]){var o=r.extensions[p],s=t.createInstancedMesh();for(var i in o.attributes)s.setAttribute(i,e.accessors[o.attributes[i]]);e.nodes[n].setExtension(p,s)}}),this},o.prewrite=function(e){e.accessorUsageGroupedByParent.add("INSTANCE_ATTRIBUTE");for(var t,r=a(this.properties);!(t=r()).done;)for(var n,o=a(t.value.listAttributes());!(n=o()).done;)e.addAccessorToUsageGroup(n.value,"INSTANCE_ATTRIBUTE");return this},o.write=function(e){var t=e.jsonDoc;return this.doc.getRoot().listNodes().forEach(function(r){var n=r.getExtension(p);if(n){var o=e.nodeIndexMap.get(r),s=t.json.nodes[o],i={attributes:{}};n.listSemantics().forEach(function(t){var r=n.getAttribute(t);i.attributes[t]=e.accessorIndexMap.get(r)}),s.extensions=s.extensions||{},s.extensions[p]=i}}),this},r}(e.Extension);T.EXTENSION_NAME=p,function(e){e.QUANTIZE="quantize",e.FILTER="filter"}(l||(l={})),function(e){e.ATTRIBUTES="ATTRIBUTES",e.TRIANGLES="TRIANGLES",e.INDICES="INDICES"}(h||(h={})),function(e){e.NONE="NONE",e.OCTAHEDRAL="OCTAHEDRAL",e.QUATERNION="QUATERNION",e.EXPONENTIAL="EXPONENTIAL"}(f||(f={}));var x=e.Accessor.ComponentType,d=x.BYTE,g=x.SHORT,y=x.FLOAT,v=e.MathUtils.normalize,m=e.MathUtils.denormalize;function E(t,r,n,o){var s=o.filter,i=o.bits,a={array:t.getArray(),byteStride:t.getElementSize()*t.getComponentSize(),componentType:t.getComponentType(),normalized:t.getNormalized()};if(n!==h.ATTRIBUTES)return a;if(s!==f.NONE){var u=t.getNormalized()?function(e){for(var t=e.getComponentType(),r=e.getArray(),n=new Float32Array(r.length),o=0;o<r.length;o++)n[o]=m(r[o],t);return n}(t):new Float32Array(a.array);switch(s){case f.EXPONENTIAL:a.byteStride=4*t.getElementSize(),a.componentType=y,a.normalized=!1,a.array=r.encodeFilterExp(u,t.getCount(),a.byteStride,i);break;case f.OCTAHEDRAL:a.byteStride=i>8?8:4,a.componentType=i>8?g:d,a.normalized=!0,u=3===t.getElementSize()?function(e){for(var t=new Float32Array(4*e.length/3),r=0,n=e.length/3;r<n;r++)t[4*r]=e[3*r],t[4*r+1]=e[3*r+1],t[4*r+2]=e[3*r+2];return t}(u):u,a.array=r.encodeFilterOct(u,t.getCount(),a.byteStride,i);break;case f.QUATERNION:a.byteStride=8,a.componentType=g,a.normalized=!0,a.array=r.encodeFilterQuat(u,t.getCount(),a.byteStride,i);break;default:throw new Error("Invalid filter.")}a.min=t.getMin([]),a.max=t.getMax([]),t.getNormalized()&&(a.min=a.min.map(function(e){return m(e,t.getComponentType())}),a.max=a.max.map(function(e){return m(e,t.getComponentType())})),a.normalized&&(a.min=a.min.map(function(e){return v(e,a.componentType)}),a.max=a.max.map(function(e){return v(e,a.componentType)}))}else a.byteStride%4&&(a.array=function(t,r){for(var n=e.BufferUtils.padNumber(t.BYTES_PER_ELEMENT*r)/t.BYTES_PER_ELEMENT,o=new t.constructor(t.length/r*n),s=0;s*r<t.length;s++)for(var i=0;i<r;i++)o[s*n+i]=t[s*r+i];return o}(a.array,t.getElementSize()),a.byteStride=a.array.byteLength/t.getCount());return a}function C(t,r){return r===e.WriterContext.BufferViewUsage.ELEMENT_ARRAY_BUFFER?t.listParents().some(function(t){return t instanceof e.Primitive&&t.getMode()===e.Primitive.Mode.TRIANGLES})?h.TRIANGLES:h.INDICES:h.ATTRIBUTES}function _(e,t){for(var r,n=a(t.getGraph().listParentLinks(e).map(function(e){return e.getName()}).filter(function(e){return"accessor"!==e}));!(r=n()).done;){var o=r.value;if("indices"===o)return{filter:f.NONE};if("POSITION"===o)return{filter:f.NONE};if("TEXCOORD_0"===o)return{filter:f.NONE};if("NORMAL"===o)return{filter:f.OCTAHEDRAL,bits:8};if("TANGENT"===o)return{filter:f.OCTAHEDRAL,bits:8};if(o.startsWith("JOINTS_"))return{filter:f.NONE};if(o.startsWith("WEIGHTS_"))return{filter:f.NONE};if("output"===o){var s=I(e);return"rotation"===s?{filter:f.QUATERNION,bits:16}:"translation"===s||"scale"===s?{filter:f.EXPONENTIAL,bits:12}:{filter:f.NONE}}if("input"===o)return{filter:f.EXPONENTIAL,bits:12};if("inverseBindMatrices"===o)return{filter:f.NONE}}return{filter:f.NONE}}function I(t){for(var r,n=a(t.listParents());!(r=n()).done;){var o=r.value;if(o instanceof e.AnimationSampler)for(var s,i=a(o.listParents());!(s=i()).done;){var u=s.value;if(u instanceof e.AnimationChannel)return u.getTargetPath()}}return null}var N="EXT_meshopt_compression",A={method:l.QUANTIZE},R=function(t){function o(){for(var r,n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return(r=t.call.apply(t,[this].concat(o))||this).extensionName=N,r.prereadTypes=[e.PropertyType.BUFFER,e.PropertyType.PRIMITIVE],r.prewriteTypes=[e.PropertyType.BUFFER,e.PropertyType.ACCESSOR],r.readDependencies=["meshopt.decoder"],r.writeDependencies=["meshopt.encoder"],r._decoder=null,r._decoderFallbackBufferMap=new Map,r._encoder=null,r._encoderOptions=A,r._encoderFallbackBuffer=null,r._encoderBufferViews={},r._encoderBufferViewData={},r._encoderBufferViewAccessors={},r}n(o,t);var s=o.prototype;return s.install=function(e,t){return"meshopt.decoder"===e&&(this._decoder=t),"meshopt.encoder"===e&&(this._encoder=t),this},s.setEncoderOptions=function(e){return this._encoderOptions=r({},A,e),this},s.preread=function(t,r){if(!this._decoder){if(!this.isRequired())return this;throw new Error("["+N+'] Please install extension dependency, "meshopt.decoder".')}if(!this._decoder.supported){if(!this.isRequired())return this;throw new Error("["+N+"]: Missing WASM support.")}return r===e.PropertyType.BUFFER?this._prereadBuffers(t):r===e.PropertyType.PRIMITIVE&&this._prereadPrimitives(t),this},s._prereadBuffers=function(t){var r=this,n=t.jsonDoc;(n.json.bufferViews||[]).forEach(function(o,s){if(o.extensions&&o.extensions[N]){var i=o.extensions[N],a=i.byteOffset||0,u=i.byteLength||0,c=i.count,l=i.byteStride,h=new Uint8Array(new ArrayBuffer(c*l)),f=n.json.buffers[o.buffer],p=new Uint8Array(f.uri?n.resources[f.uri]:n.resources[e.GLB_BUFFER],a,u);r._decoder.decodeGltfBuffer(h,c,l,p,i.mode,i.filter),t.bufferViews[s]=h}})},s._prereadPrimitives=function(e){var t=this,r=e.jsonDoc;(r.json.bufferViews||[]).forEach(function(n){var o;n.extensions&&n.extensions[N]&&(o=r.json.buffers[n.buffer]).extensions&&o.extensions.EXT_meshopt_compression&&o.extensions.EXT_meshopt_compression.fallback&&t._decoderFallbackBufferMap.set(e.buffers[n.buffer],e.buffers[n.extensions[N].buffer])})},s.read=function(t){if(!this.isRequired())return this;for(var r,n=a(this._decoderFallbackBufferMap);!(r=n()).done;){for(var o,s=r.value,i=s[0],u=s[1],c=a(i.listParents());!(o=c()).done;){var l=o.value;l instanceof e.Accessor&&l.swap(i,u)}i.dispose()}return this},s.prewrite=function(t,r){return r===e.PropertyType.ACCESSOR?this._prewriteAccessors(t):r===e.PropertyType.BUFFER&&this._prewriteBuffers(t),this},s._prewriteAccessors=function(t){var r=t.jsonDoc.json,n=this._encoder,o=this._encoderOptions,s=this.doc.createBuffer(),i=this.doc.getRoot().listBuffers().indexOf(s);this._encoderFallbackBuffer=s,this._encoderBufferViews={},this._encoderBufferViewData={},this._encoderBufferViewAccessors={};for(var u,c=a(this.doc.getRoot().listAccessors());!(u=c()).done;){var h=u.value;if("weights"!==I(h)){var p=t.getAccessorUsage(h),T=C(h,p),x=o.method===l.FILTER?_(h,this.doc):{filter:f.NONE},d=E(h,n,T,x),g=d.array,y=d.byteStride,v=h.getBuffer();if(!v)throw new Error(N+": Missing buffer for accessor.");var m,A=this.doc.getRoot().listBuffers().indexOf(v),R=[p,T,x,y,A].join(":"),S=this._encoderBufferViews[R],w=this._encoderBufferViewData[R],O=this._encoderBufferViewAccessors[R];S&&w||(O=this._encoderBufferViewAccessors[R]=[],w=this._encoderBufferViewData[R]=[],S=this._encoderBufferViews[R]={buffer:i,target:e.WriterContext.USAGE_TO_TARGET[p],byteOffset:0,byteLength:0,byteStride:p===e.WriterContext.BufferViewUsage.ARRAY_BUFFER?y:void 0,extensions:(m={},m[N]={buffer:A,byteOffset:0,byteLength:0,mode:T,filter:x.filter!==f.NONE?x.filter:void 0,byteStride:y,count:0},m)});var M=t.createAccessorDef(h);M.componentType=d.componentType,M.normalized=d.normalized,M.byteOffset=S.byteLength,M.min&&d.min&&(M.min=d.min),M.max&&d.max&&(M.max=d.max),t.accessorIndexMap.set(h,r.accessors.length),r.accessors.push(M),O.push(M),w.push(g.slice().buffer),S.byteLength+=g.byteLength,S.extensions.EXT_meshopt_compression.count+=h.getCount()}}},s._prewriteBuffers=function(t){var r=this._encoder;for(var n in this._encoderBufferViews){var o=this._encoderBufferViews[n],s=this._encoderBufferViewData[n],i=this.doc.getRoot().listBuffers()[o.extensions[N].buffer],a=t.otherBufferViews.get(i)||[],u=o.extensions[N],c=u.count,l=u.byteStride,h=u.mode,f=new Uint8Array(e.BufferUtils.concat(s)),p=r.encodeGltfBuffer(f,c,l,h),T=e.BufferUtils.pad(p.slice().buffer);o.extensions[N].byteLength=p.byteLength,s.length=0,s.push(T),a.push(T),t.otherBufferViews.set(i,a)}},s.write=function(t){var r,n=0;for(var o in this._encoderBufferViews){for(var s,i=this._encoderBufferViews[o],u=t.otherBufferViewsIndexMap.get(this._encoderBufferViewData[o][0]),c=a(this._encoderBufferViewAccessors[o]);!(s=c()).done;)s.value.bufferView=u;var l=t.jsonDoc.json.bufferViews[u],h=l.byteOffset||0;Object.assign(l,i),l.byteOffset=n,l.extensions[N].byteOffset=h,n+=e.BufferUtils.padNumber(i.byteLength)}var f=this._encoderFallbackBuffer,p=t.bufferIndexMap.get(f),T=t.jsonDoc.json.buffers[p];return T.byteLength=n,T.extensions=((r={})[N]={fallback:!0},r),f.dispose(),this},o}(e.Extension);R.EXTENSION_NAME=N,R.EncoderMethod=l;var S="EXT_texture_webp",w=function(){function t(){}var r=t.prototype;return r.getSize=function(t){var r=e.BufferUtils.decodeText(t.slice(0,4)),n=e.BufferUtils.decodeText(t.slice(8,12));if("RIFF"!==r||"WEBP"!==n)return null;for(var o=new DataView(t),s=12;s<t.byteLength;){var i=e.BufferUtils.decodeText(t.slice(s,s+4)),a=o.getUint32(s+4,!0);if("VP8 "===i)return[16383&o.getInt16(s+14,!0),16383&o.getInt16(s+16,!0)];if("VP8L"===i){var u=o.getUint8(s+9),c=o.getUint8(s+10),l=o.getUint8(s+11);return[1+((63&c)<<8|u),1+((15&o.getUint8(s+12))<<10|l<<2|(192&c)>>6)]}s+=8+a+a%2}return null},r.getChannels=function(e){return 4},t}(),O=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return(r=t.call.apply(t,[this].concat(o))||this).extensionName=S,r.prereadTypes=[e.PropertyType.TEXTURE],r}n(r,t),r.register=function(){e.ImageUtils.registerFormat("image/webp",new w)};var o=r.prototype;return o.preread=function(e){return(e.jsonDoc.json.textures||[]).forEach(function(e){e.extensions&&e.extensions[S]&&(e.source=e.extensions[S].source)}),this},o.read=function(e){return this},o.write=function(e){var t=e.jsonDoc;return this.doc.getRoot().listTextures().forEach(function(r){if("image/webp"===r.getMimeType()){var n=e.imageIndexMap.get(r);(t.json.textures||[]).forEach(function(e){e.source===n&&(e.extensions=e.extensions||{},e.extensions[S]={source:e.source},delete e.source)})}}),this},r}(e.Extension);O.EXTENSION_NAME=S;var M,F,b,D,G,P,B,U="KHR_draco_mesh_compression";function j(e,t){var r=new M.DecoderBuffer;try{if(r.Init(t,t.length),e.GetEncodedGeometryType(r)!==M.TRIANGULAR_MESH)throw new Error("["+U+"] Unknown geometry type.");var n=new M.Mesh;if(!e.DecodeBufferToMesh(r,n).ok()||0===n.ptr)throw new Error("["+U+"] Decoding failure.");return n}finally{M.destroy(r)}}function L(e,t){var r,n,o=3*t.num_faces();if(t.num_points()<=65534){var s=o*Uint16Array.BYTES_PER_ELEMENT;r=M._malloc(s),e.GetTrianglesUInt16Array(t,s,r),n=new Uint16Array(M.HEAPU16.buffer,r,o).slice()}else{var i=o*Uint32Array.BYTES_PER_ELEMENT;r=M._malloc(i),e.GetTrianglesUInt32Array(t,i,r),n=new Uint32Array(M.HEAPU32.buffer,r,o).slice()}return M._free(r),n}function k(e,t,r,n){var o=b[n.componentType],s=F[n.componentType],i=r.num_components(),a=t.num_points()*i,u=a*s.BYTES_PER_ELEMENT,c=M._malloc(u);e.GetAttributeDataArrayForAllPoints(t,r,o,u,c);var l=new s(M.HEAPF32.buffer,c,a).slice();return M._free(c),l}!function(e){e[e.EDGEBREAKER=1]="EDGEBREAKER",e[e.SEQUENTIAL=0]="SEQUENTIAL"}(P||(P={})),function(e){e.POSITION="POSITION",e.NORMAL="NORMAL",e.COLOR="COLOR",e.TEX_COORD="TEX_COORD",e.GENERIC="GENERIC"}(B||(B={}));var H=((D={})[B.POSITION]=14,D[B.NORMAL]=10,D[B.COLOR]=8,D[B.TEX_COORD]=12,D[B.GENERIC]=12,D),V={decodeSpeed:5,encodeSpeed:5,method:P.EDGEBREAKER,quantizationBits:H,quantizationVolume:"mesh"};function X(e,t){void 0===t&&(t=V);var n=r({},V,t);n.quantizationBits=r({},H,t.quantizationBits);for(var o,s=new G.Encoder,i=new G.MeshBuilder,u=new G.Mesh,c={},l=new G.DracoInt8Array,h=a(e.listSemantics());!(o=h()).done;){var f=o.value,p=e.getAttribute(f),T=K(f),x=z(i,p.getComponentType(),u,G[T],p.getCount(),p.getElementSize(),p.getArray());if(-1===x)throw new Error('Error compressing "'+f+'" attribute.');if(c[f]=x,"mesh"===n.quantizationVolume||"POSITION"!==f)s.SetAttributeQuantization(G[T],n.quantizationBits[T]);else{if("object"!=typeof n.quantizationVolume)throw new Error("Invalid quantization volume state.");var d=n.quantizationVolume,g=Math.max(d.max[0]-d.min[0],d.max[1]-d.min[1],d.max[2]-d.min[2]);s.SetAttributeExplicitQuantization(G[T],n.quantizationBits[T],p.getElementSize(),d.min,g)}}var y=e.getIndices();if(!y)throw new Error("Primitive must have indices.");i.AddFacesToMesh(u,y.getCount()/3,y.getArray()),s.SetSpeedOptions(n.encodeSpeed,n.decodeSpeed),s.SetTrackEncodedProperties(!0),n.method===P.SEQUENTIAL||e.listTargets().length>0?s.SetEncodingMethod(G.MESH_SEQUENTIAL_ENCODING):s.SetEncodingMethod(G.MESH_EDGEBREAKER_ENCODING);var v=s.EncodeMeshToDracoBuffer(u,l);if(v<=0)throw new Error("Error applying Draco compression.");for(var m=new Uint8Array(v),E=0;E<v;++E)m[E]=l.GetValue(E);var C=e.getAttribute("POSITION").getCount(),_=s.GetNumberOfEncodedPoints(),I=3*s.GetNumberOfEncodedFaces();if(e.listTargets().length>0&&_!==C)throw new Error('Compression reduced vertex count unexpectedly, corrupting morph targets. Applying the "weld" function before compression may resolve the issue.');return G.destroy(l),G.destroy(u),G.destroy(i),G.destroy(s),{numVertices:_,numIndices:I,data:m,attributeIDs:c}}function K(e){return"POSITION"===e?B.POSITION:"NORMAL"===e?B.NORMAL:e.startsWith("COLOR_")?B.COLOR:e.startsWith("TEXCOORD_")?B.TEX_COORD:B.GENERIC}function z(t,r,n,o,s,i,a){switch(r){case e.Accessor.ComponentType.UNSIGNED_BYTE:return t.AddUInt8Attribute(n,o,s,i,a);case e.Accessor.ComponentType.BYTE:return t.AddInt8Attribute(n,o,s,i,a);case e.Accessor.ComponentType.UNSIGNED_SHORT:return t.AddUInt16Attribute(n,o,s,i,a);case e.Accessor.ComponentType.SHORT:return t.AddInt16Attribute(n,o,s,i,a);case e.Accessor.ComponentType.UNSIGNED_INT:return t.AddUInt32Attribute(n,o,s,i,a);case e.Accessor.ComponentType.FLOAT:return t.AddFloatAttribute(n,o,s,i,a);default:throw new Error('Unexpected component type, "'+r+'".')}}var Y="KHR_draco_mesh_compression",q=function(t){function o(){for(var r,n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return(r=t.call.apply(t,[this].concat(o))||this).extensionName=Y,r.prereadTypes=[e.PropertyType.PRIMITIVE],r.prewriteTypes=[e.PropertyType.ACCESSOR],r.readDependencies=["draco3d.decoder"],r.writeDependencies=["draco3d.encoder"],r._decoderModule=null,r._encoderModule=null,r._encoderOptions={},r}n(o,t);var s=o.prototype;return s.install=function(t,r){var n,o;return"draco3d.decoder"===t&&(this._decoderModule=r,M=this._decoderModule,(n={})[e.Accessor.ComponentType.FLOAT]=Float32Array,n[e.Accessor.ComponentType.UNSIGNED_INT]=Uint32Array,n[e.Accessor.ComponentType.UNSIGNED_SHORT]=Uint16Array,n[e.Accessor.ComponentType.UNSIGNED_BYTE]=Uint8Array,n[e.Accessor.ComponentType.SHORT]=Int16Array,n[e.Accessor.ComponentType.BYTE]=Int8Array,F=n,(o={})[e.Accessor.ComponentType.FLOAT]=M.DT_FLOAT32,o[e.Accessor.ComponentType.UNSIGNED_INT]=M.DT_UINT32,o[e.Accessor.ComponentType.UNSIGNED_SHORT]=M.DT_UINT16,o[e.Accessor.ComponentType.UNSIGNED_BYTE]=M.DT_UINT8,o[e.Accessor.ComponentType.SHORT]=M.DT_INT16,o[e.Accessor.ComponentType.BYTE]=M.DT_INT8,b=o),"draco3d.encoder"===t&&(this._encoderModule=r,G=this._encoderModule),this},s.setEncoderOptions=function(e){return this._encoderOptions=e,this},s.preread=function(t){if(!this._decoderModule)throw new Error("["+Y+'] Please install extension dependency, "draco3d.decoder".');var r=this.doc.getLogger(),n=t.jsonDoc,o=new Map;try{for(var s,i=a(n.json.meshes||[]);!(s=i()).done;)for(var u,c=a(s.value.primitives);!(u=c()).done;){var l=u.value;if(l.extensions&&l.extensions[Y]){var h=l.extensions[Y],f=o.get(h.bufferView)||[],p=f[0],T=f[1];if(!T||!p){var x=n.json.bufferViews[h.bufferView],d=n.json.buffers[x.buffer],g=new Int8Array(d.uri?n.resources[d.uri]:n.resources[e.GLB_BUFFER],x.byteOffset||0,x.byteLength);T=j(p=new this._decoderModule.Decoder,g),o.set(h.bufferView,[p,T]),r.debug("["+Y+"] Decompressed "+g.byteLength+" bytes.")}for(var y in l.attributes){var v=t.jsonDoc.json.accessors[l.attributes[y]],m=p.GetAttributeByUniqueId(T,h.attributes[y]),E=k(p,T,m,v);t.accessors[l.attributes[y]].setArray(E)}void 0!==l.indices&&t.accessors[l.indices].setArray(L(p,T))}}}finally{for(var C=0,_=Array.from(o.values());C<_.length;C++){var I=_[C],N=I[1];this._decoderModule.destroy(I[0]),this._decoderModule.destroy(N)}}return this},s.read=function(e){return this},s.prewrite=function(t,n){if(!this._encoderModule)throw new Error("["+Y+'] Please install extension dependency, "draco3d.encoder".');var o=this.doc.getLogger();o.debug("["+Y+"] Compression options: "+JSON.stringify(this._encoderOptions));var s=function(t){for(var r,n=t.getLogger(),o=new Set,s=new Set,i=a(t.getRoot().listMeshes());!(r=i()).done;)for(var u,c=a(r.value.listPrimitives());!(u=c()).done;){var l=u.value;l.getIndices()?l.getMode()!==e.Primitive.Mode.TRIANGLES?(s.add(l),n.warn("["+Y+"] Skipping Draco compression on non-TRIANGLES primitive.")):o.add(l):(s.add(l),n.warn("["+Y+"] Skipping Draco compression on non-indexed primitive."))}for(var h=t.getRoot().listAccessors(),f=new Map,p=0;p<h.length;p++)f.set(h[p],p);for(var T=new Map,x=new Set,d=new Map,g=0,y=Array.from(o);g<y.length;g++){var v=y[g],m=Q(v,f);if(x.has(m))d.set(v,m);else{if(T.has(v.getIndices())){var E=v.getIndices(),C=E.clone();f.set(C,t.getRoot().listAccessors().length-1),v.swap(E,C)}for(var _,I=a(v.listAttributes());!(_=I()).done;){var N=_.value;if(T.has(N)){var A=N.clone();f.set(A,t.getRoot().listAccessors().length-1),v.swap(N,A)}}m=Q(v,f),x.add(m),d.set(v,m),T.set(v.getIndices(),m);for(var R,S=a(v.listAttributes());!(R=S()).done;)T.set(R.value,m)}}for(var w=0,O=Array.from(T.keys());w<O.length;w++){var M=new Set(O[w].listParents().map(function(e){return e.propertyType}));if(2!==M.size||!M.has("Primitive")||!M.has("Root"))throw new Error("["+Y+"] Compressed accessors must only be used as indices or vertex attributes.")}for(var F=function(){var e=D[b],t=d.get(e),r=e.getIndices();if(T.get(r)!==t||e.listAttributes().some(function(e){return T.get(e)!==t}))throw new Error("["+Y+"] Draco primitives must share all, or no, accessors.")},b=0,D=Array.from(o);b<D.length;b++)F();for(var G=0,P=Array.from(s);G<P.length;G++){var B=P[G],U=B.getIndices();if(T.has(U)||B.listAttributes().some(function(e){return T.has(e)}))throw new Error("["+Y+"] Accessor cannot be shared by compressed and uncompressed primitives.")}return d}(this.doc),i=new Map,u="mesh";"scene"===this._encoderOptions.quantizationVolume&&(1!==this.doc.getRoot().listScenes().length?o.warn("["+Y+"]: quantizationVolume=scene requires exactly 1 scene."):u=e.bounds(this.doc.getRoot().listScenes().pop()));for(var c=0,l=Array.from(s.keys());c<l.length;c++){var h=l[c],f=s.get(h);if(!f)throw new Error("Unexpected primitive.");if(i.has(f))i.set(f,i.get(f));else{var p=h.getIndices(),T=t.jsonDoc.json.accessors,x=X(h,r({},this._encoderOptions,{quantizationVolume:u}));i.set(f,x);var d=t.createAccessorDef(p);d.count=x.numIndices,t.accessorIndexMap.set(p,T.length),T.push(d);for(var g,y=a(h.listSemantics());!(g=y()).done;){var v=h.getAttribute(g.value),m=t.createAccessorDef(v);m.count=x.numVertices,t.accessorIndexMap.set(v,T.length),T.push(m)}var E=h.getAttribute("POSITION").getBuffer()||this.doc.getRoot().listBuffers()[0];t.otherBufferViews.has(E)||t.otherBufferViews.set(E,[]),t.otherBufferViews.get(E).push(x.data)}}return o.debug("["+Y+"] Compressed "+s.size+" primitives."),t.extensionData[Y]={primitiveHashMap:s,primitiveEncodingMap:i},this},s.write=function(e){for(var t,r=e.extensionData[Y],n=a(this.doc.getRoot().listMeshes());!(t=n()).done;)for(var o=t.value,s=e.jsonDoc.json.meshes[e.meshIndexMap.get(o)],i=0;i<o.listPrimitives().length;i++){var u=o.listPrimitives()[i],c=s.primitives[i],l=r.primitiveHashMap.get(u);if(l){var h=r.primitiveEncodingMap.get(l);c.extensions=c.extensions||{},c.extensions[Y]={bufferView:e.otherBufferViewsIndexMap.get(h.data),attributes:h.attributeIDs}}}if(!r.primitiveHashMap.size){var f=e.jsonDoc.json;f.extensionsUsed=(f.extensionsUsed||[]).filter(function(e){return e!==Y}),f.extensionsRequired=(f.extensionsRequired||[]).filter(function(e){return e!==Y})}return this},o}(e.Extension);function Q(e,t){var r=[],n=e.getIndices();r.push(t.get(n));for(var o,s=a(e.listAttributes());!(o=s()).done;)r.push(t.get(o.value));return r.sort().join("|")}q.EXTENSION_NAME=Y,q.EncoderMethod=P;var W=function(t){function r(){for(var n,o=arguments.length,s=new Array(o),i=0;i<o;i++)s[i]=arguments[i];return(n=t.call.apply(t,[this].concat(s))||this).propertyType="Light",n.parentTypes=[e.PropertyType.NODE],n.extensionName="KHR_lights_punctual",n._color=[1,1,1],n._intensity=1,n._type=r.Type.POINT,n._range=null,n._innerConeAngle=0,n._outerConeAngle=Math.PI/4,n}n(r,t);var o=r.prototype;return o.copy=function(r,n){return void 0===n&&(n=e.COPY_IDENTITY),t.prototype.copy.call(this,r,n),this._color=[].concat(r._color),this._intensity=r._intensity,this._type=r._type,this._range=r._range,this._innerConeAngle=r._innerConeAngle,this._outerConeAngle=r._outerConeAngle,this},o.getColor=function(){return this._color},o.setColor=function(e){return this._color=e,this},o.getColorHex=function(){return e.ColorUtils.factorToHex(this._color)},o.setColorHex=function(t){return e.ColorUtils.hexToFactor(t,this._color),this},o.getIntensity=function(){return this._intensity},o.setIntensity=function(e){return this._intensity=e,this},o.getType=function(){return this._type},o.setType=function(e){return this._type=e,this},o.getRange=function(){return this._range},o.setRange=function(e){return this._range=e,this},o.getInnerConeAngle=function(){return this._innerConeAngle},o.setInnerConeAngle=function(e){return this._innerConeAngle=e,this},o.getOuterConeAngle=function(){return this._outerConeAngle},o.setOuterConeAngle=function(e){return this._outerConeAngle=e,this},r}(e.ExtensionProperty);W.EXTENSION_NAME="KHR_lights_punctual",W.Type={POINT:"point",SPOT:"spot",DIRECTIONAL:"directional"};var J="KHR_lights_punctual",Z=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(e=t.call.apply(t,[this].concat(n))||this).extensionName=J,e}n(r,t);var o=r.prototype;return o.createLight=function(){return new W(this.doc.getGraph(),this)},o.read=function(e){var t=this,r=e.jsonDoc;if(!r.json.extensions||!r.json.extensions[J])return this;var n=(r.json.extensions[J].lights||[]).map(function(e){var r=t.createLight().setName(e.name||"").setType(e.type);return void 0!==e.color&&r.setColor(e.color),void 0!==e.intensity&&r.setIntensity(e.intensity),void 0!==e.range&&r.setRange(e.range),void 0!==e.innerConeAngle&&r.setInnerConeAngle(e.innerConeAngle),void 0!==e.outerConeAngle&&r.setOuterConeAngle(e.outerConeAngle),r});return r.json.nodes.forEach(function(t,r){t.extensions&&t.extensions[J]&&e.nodes[r].setExtension(J,n[t.extensions[J].light])}),this},o.write=function(t){var r=t.jsonDoc;if(0===this.properties.size)return this;for(var n,o=[],s=new Map,i=a(this.properties);!(n=i()).done;){var u=n.value,c={type:u.getType()};e.MathUtils.eq(u.getColor(),[1,1,1])||(c.color=u.getColor()),1!==u.getIntensity()&&(c.intensity=u.getIntensity()),null!=u.getRange()&&(c.range=u.getRange()),u.getName()&&(c.name=u.getName()),u.getType()===W.Type.SPOT&&(c.innerConeAngle=u.getInnerConeAngle(),c.outerConeAngle=u.getOuterConeAngle()),o.push(c),s.set(u,o.length-1)}return this.doc.getRoot().listNodes().forEach(function(e){var n=e.getExtension(J);if(n){var o=t.nodeIndexMap.get(e),i=r.json.nodes[o];i.extensions=i.extensions||{},i.extensions[J]={light:s.get(n)}}}),r.json.extensions=r.json.extensions||{},r.json.extensions[J]={lights:o},this},r}(e.Extension);Z.EXTENSION_NAME=J;var $=e.TextureChannel.R,ee=e.TextureChannel.G,te=e.TextureChannel.B,re=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return(r=t.call.apply(t,[this].concat(o))||this).propertyType="Clearcoat",r.parentTypes=[e.PropertyType.MATERIAL],r.extensionName="KHR_materials_clearcoat",r._clearcoatFactor=0,r._clearcoatRoughnessFactor=0,r._clearcoatNormalScale=1,r.clearcoatTexture=null,r.clearcoatTextureInfo=r.graph.link("clearcoatTextureInfo",s(r),new e.TextureInfo(r.graph)),r.clearcoatRoughnessTexture=null,r.clearcoatRoughnessTextureInfo=r.graph.link("clearcoatRoughnessTextureInfo",s(r),new e.TextureInfo(r.graph)),r.clearcoatNormalTexture=null,r.clearcoatNormalTextureInfo=r.graph.link("clearcoatNormalTextureInfo",s(r),new e.TextureInfo(r.graph)),r}n(r,t);var o=r.prototype;return o.copy=function(r,n){return void 0===n&&(n=e.COPY_IDENTITY),t.prototype.copy.call(this,r,n),this._clearcoatFactor=r._clearcoatFactor,this._clearcoatRoughnessFactor=r._clearcoatRoughnessFactor,this._clearcoatNormalScale=r._clearcoatNormalScale,this.setClearcoatTexture(r.clearcoatTexture?n(r.clearcoatTexture.getChild()):null),this.clearcoatTextureInfo.getChild().copy(n(r.clearcoatTextureInfo.getChild()),n),this.setClearcoatRoughnessTexture(r.clearcoatRoughnessTexture?n(r.clearcoatRoughnessTexture.getChild()):null),this.clearcoatRoughnessTextureInfo.getChild().copy(n(r.clearcoatRoughnessTextureInfo.getChild()),n),this.setClearcoatNormalTexture(r.clearcoatNormalTexture?n(r.clearcoatNormalTexture.getChild()):null),this.clearcoatNormalTextureInfo.getChild().copy(n(r.clearcoatNormalTextureInfo.getChild()),n),this},o.dispose=function(){this.clearcoatTextureInfo.getChild().dispose(),this.clearcoatRoughnessTextureInfo.getChild().dispose(),this.clearcoatNormalTextureInfo.getChild().dispose(),t.prototype.dispose.call(this)},o.getClearcoatFactor=function(){return this._clearcoatFactor},o.setClearcoatFactor=function(e){return this._clearcoatFactor=e,this},o.getClearcoatTexture=function(){return this.clearcoatTexture?this.clearcoatTexture.getChild():null},o.getClearcoatTextureInfo=function(){return this.clearcoatTexture?this.clearcoatTextureInfo.getChild():null},o.setClearcoatTexture=function(e){return this.clearcoatTexture=this.graph.linkTexture("clearcoatTexture",$,this,e),this},o.getClearcoatRoughnessFactor=function(){return this._clearcoatRoughnessFactor},o.setClearcoatRoughnessFactor=function(e){return this._clearcoatRoughnessFactor=e,this},o.getClearcoatRoughnessTexture=function(){return this.clearcoatRoughnessTexture?this.clearcoatRoughnessTexture.getChild():null},o.getClearcoatRoughnessTextureInfo=function(){return this.clearcoatRoughnessTexture?this.clearcoatRoughnessTextureInfo.getChild():null},o.setClearcoatRoughnessTexture=function(e){return this.clearcoatRoughnessTexture=this.graph.linkTexture("clearcoatRoughnessTexture",ee,this,e),this},o.getClearcoatNormalScale=function(){return this._clearcoatNormalScale},o.setClearcoatNormalScale=function(e){return this._clearcoatNormalScale=e,this},o.getClearcoatNormalTexture=function(){return this.clearcoatNormalTexture?this.clearcoatNormalTexture.getChild():null},o.getClearcoatNormalTextureInfo=function(){return this.clearcoatNormalTexture?this.clearcoatNormalTextureInfo.getChild():null},o.setClearcoatNormalTexture=function(e){return this.clearcoatNormalTexture=this.graph.linkTexture("clearcoatNormalTexture",$|ee|te,this,e),this},r}(e.ExtensionProperty);re.EXTENSION_NAME="KHR_materials_clearcoat",u([e.GraphChild],re.prototype,"clearcoatTexture",void 0),u([e.GraphChild],re.prototype,"clearcoatTextureInfo",void 0),u([e.GraphChild],re.prototype,"clearcoatRoughnessTexture",void 0),u([e.GraphChild],re.prototype,"clearcoatRoughnessTextureInfo",void 0),u([e.GraphChild],re.prototype,"clearcoatNormalTexture",void 0),u([e.GraphChild],re.prototype,"clearcoatNormalTextureInfo",void 0);var ne="KHR_materials_clearcoat",oe=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(t=e.call.apply(e,[this].concat(n))||this).extensionName=ne,t}n(t,e);var r=t.prototype;return r.createClearcoat=function(){return new re(this.doc.getGraph(),this)},r.read=function(e){var t=this,r=e.jsonDoc,n=r.json.textures||[];return(r.json.materials||[]).forEach(function(r,o){if(r.extensions&&r.extensions[ne]){var s=t.createClearcoat();e.materials[o].setExtension(ne,s);var i=r.extensions[ne];if(void 0!==i.clearcoatFactor&&s.setClearcoatFactor(i.clearcoatFactor),void 0!==i.clearcoatRoughnessFactor&&s.setClearcoatRoughnessFactor(i.clearcoatRoughnessFactor),void 0!==i.clearcoatTexture){var a=i.clearcoatTexture;s.setClearcoatTexture(e.textures[n[a.index].source]),e.setTextureInfo(s.getClearcoatTextureInfo(),a)}if(void 0!==i.clearcoatRoughnessTexture){var u=i.clearcoatRoughnessTexture;s.setClearcoatRoughnessTexture(e.textures[n[u.index].source]),e.setTextureInfo(s.getClearcoatRoughnessTextureInfo(),u)}if(void 0!==i.clearcoatNormalTexture){var c=i.clearcoatNormalTexture;s.setClearcoatNormalTexture(e.textures[n[c.index].source]),e.setTextureInfo(s.getClearcoatNormalTextureInfo(),c),void 0!==c.scale&&s.setClearcoatNormalScale(c.scale)}}}),this},r.write=function(e){var t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(function(r){var n=r.getExtension(ne);if(n){var o=e.materialIndexMap.get(r),s=t.json.materials[o];s.extensions=s.extensions||{};var i=s.extensions[ne]={clearcoatFactor:n.getClearcoatFactor(),clearcoatRoughnessFactor:n.getClearcoatRoughnessFactor()};if(n.getClearcoatTexture()){var a=n.getClearcoatTexture(),u=n.getClearcoatTextureInfo();i.clearcoatTexture=e.createTextureInfoDef(a,u)}if(n.getClearcoatRoughnessTexture()){var c=n.getClearcoatRoughnessTexture(),l=n.getClearcoatRoughnessTextureInfo();i.clearcoatRoughnessTexture=e.createTextureInfoDef(c,l)}if(n.getClearcoatNormalTexture()){var h=n.getClearcoatNormalTexture(),f=n.getClearcoatNormalTextureInfo();i.clearcoatNormalTexture=e.createTextureInfoDef(h,f),1!==n.getClearcoatNormalScale()&&(i.clearcoatNormalTexture.scale=n.getClearcoatNormalScale())}}}),this},t}(e.Extension);oe.EXTENSION_NAME=ne;var se=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return(r=t.call.apply(t,[this].concat(o))||this).propertyType="IOR",r.parentTypes=[e.PropertyType.MATERIAL],r.extensionName="KHR_materials_ior",r._ior=0,r}n(r,t);var o=r.prototype;return o.copy=function(r,n){return void 0===n&&(n=e.COPY_IDENTITY),t.prototype.copy.call(this,r,n),this._ior=r._ior,this},o.getIOR=function(){return this._ior},o.setIOR=function(e){return this._ior=e,this},r}(e.ExtensionProperty);se.EXTENSION_NAME="KHR_materials_ior";var ie="KHR_materials_ior",ae=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(t=e.call.apply(e,[this].concat(n))||this).extensionName=ie,t}n(t,e);var r=t.prototype;return r.createIOR=function(){return new se(this.doc.getGraph(),this)},r.read=function(e){var t=this;return(e.jsonDoc.json.materials||[]).forEach(function(r,n){if(r.extensions&&r.extensions[ie]){var o=t.createIOR();e.materials[n].setExtension(ie,o);var s=r.extensions[ie];void 0!==s.ior&&o.setIOR(s.ior)}}),this},r.write=function(e){var t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(function(r){var n=r.getExtension(ie);if(n){var o=e.materialIndexMap.get(r),s=t.json.materials[o];s.extensions=s.extensions||{},s.extensions[ie]={ior:n.getIOR()}}}),this},t}(e.Extension);ae.EXTENSION_NAME=ie;var ue=e.TextureChannel.R,ce=e.TextureChannel.G,le=e.TextureChannel.B,he=e.TextureChannel.A,fe=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return(r=t.call.apply(t,[this].concat(o))||this).propertyType="PBRSpecularGlossiness",r.parentTypes=[e.PropertyType.MATERIAL],r.extensionName="KHR_materials_pbrSpecularGlossiness",r._diffuseFactor=[1,1,1,1],r._specularFactor=[1,1,1],r._glossinessFactor=1,r.diffuseTexture=null,r.diffuseTextureInfo=r.graph.link("diffuseTextureInfo",s(r),new e.TextureInfo(r.graph)),r.specularGlossinessTexture=null,r.specularGlossinessTextureInfo=r.graph.link("specularGlossinessTextureInfo",s(r),new e.TextureInfo(r.graph)),r}n(r,t);var o=r.prototype;return o.copy=function(r,n){return void 0===n&&(n=e.COPY_IDENTITY),t.prototype.copy.call(this,r,n),this._diffuseFactor=r._diffuseFactor,this._specularFactor=r._specularFactor,this._glossinessFactor=r._glossinessFactor,this.setDiffuseTexture(r.diffuseTexture?n(r.diffuseTexture.getChild()):null),this.diffuseTextureInfo.getChild().copy(n(r.diffuseTextureInfo.getChild()),n),this.setSpecularGlossinessTexture(r.specularGlossinessTexture?n(r.specularGlossinessTexture.getChild()):null),this.specularGlossinessTextureInfo.getChild().copy(n(r.specularGlossinessTextureInfo.getChild()),n),this},o.dispose=function(){this.diffuseTextureInfo.getChild().dispose(),this.specularGlossinessTextureInfo.getChild().dispose(),t.prototype.dispose.call(this)},o.getDiffuseFactor=function(){return this._diffuseFactor},o.setDiffuseFactor=function(e){return this._diffuseFactor=e,this},o.getDiffuseHex=function(){return e.ColorUtils.factorToHex(this._diffuseFactor)},o.setDiffuseHex=function(t){return e.ColorUtils.hexToFactor(t,this._diffuseFactor),this},o.getDiffuseTexture=function(){return this.diffuseTexture?this.diffuseTexture.getChild():null},o.getDiffuseTextureInfo=function(){return this.diffuseTexture?this.diffuseTextureInfo.getChild():null},o.setDiffuseTexture=function(e){return this.diffuseTexture=this.graph.linkTexture("diffuseTexture",ue|ce|le|he,this,e),this},o.getSpecularFactor=function(){return this._specularFactor},o.setSpecularFactor=function(e){return this._specularFactor=e,this},o.getGlossinessFactor=function(){return this._glossinessFactor},o.setGlossinessFactor=function(e){return this._glossinessFactor=e,this},o.getSpecularGlossinessTexture=function(){return this.specularGlossinessTexture?this.specularGlossinessTexture.getChild():null},o.getSpecularGlossinessTextureInfo=function(){return this.specularGlossinessTexture?this.specularGlossinessTextureInfo.getChild():null},o.setSpecularGlossinessTexture=function(e){return this.specularGlossinessTexture=this.graph.linkTexture("specularGlossinessTexture",ue|ce|le|he,this,e),this},r}(e.ExtensionProperty);fe.EXTENSION_NAME="KHR_materials_pbrSpecularGlossiness",u([e.GraphChild],fe.prototype,"diffuseTexture",void 0),u([e.GraphChild],fe.prototype,"diffuseTextureInfo",void 0),u([e.GraphChild],fe.prototype,"specularGlossinessTexture",void 0),u([e.GraphChild],fe.prototype,"specularGlossinessTextureInfo",void 0);var pe="KHR_materials_pbrSpecularGlossiness",Te=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(t=e.call.apply(e,[this].concat(n))||this).extensionName=pe,t}n(t,e);var r=t.prototype;return r.createPBRSpecularGlossiness=function(){return new fe(this.doc.getGraph(),this)},r.read=function(e){var t=this,r=e.jsonDoc,n=r.json.textures||[];return(r.json.materials||[]).forEach(function(r,o){if(r.extensions&&r.extensions[pe]){var s=t.createPBRSpecularGlossiness();e.materials[o].setExtension(pe,s);var i=r.extensions[pe];if(void 0!==i.diffuseFactor&&s.setDiffuseFactor(i.diffuseFactor),void 0!==i.specularFactor&&s.setSpecularFactor(i.specularFactor),void 0!==i.glossinessFactor&&s.setGlossinessFactor(i.glossinessFactor),void 0!==i.diffuseTexture){var a=i.diffuseTexture;s.setDiffuseTexture(e.textures[n[a.index].source]),e.setTextureInfo(s.getDiffuseTextureInfo(),a)}if(void 0!==i.specularGlossinessTexture){var u=i.specularGlossinessTexture;s.setSpecularGlossinessTexture(e.textures[n[u.index].source]),e.setTextureInfo(s.getSpecularGlossinessTextureInfo(),u)}}}),this},r.write=function(e){var t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(function(r){var n=r.getExtension(pe);if(n){var o=e.materialIndexMap.get(r),s=t.json.materials[o];s.extensions=s.extensions||{};var i=s.extensions[pe]={diffuseFactor:n.getDiffuseFactor(),specularFactor:n.getSpecularFactor(),glossinessFactor:n.getGlossinessFactor()};if(n.getDiffuseTexture()){var a=n.getDiffuseTexture(),u=n.getDiffuseTextureInfo();i.diffuseTexture=e.createTextureInfoDef(a,u)}if(n.getSpecularGlossinessTexture()){var c=n.getSpecularGlossinessTexture(),l=n.getSpecularGlossinessTextureInfo();i.specularGlossinessTexture=e.createTextureInfoDef(c,l)}}}),this},t}(e.Extension);Te.EXTENSION_NAME=pe;var xe=e.TextureChannel.R,de=e.TextureChannel.G,ge=e.TextureChannel.B,ye=e.TextureChannel.A,ve=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return(r=t.call.apply(t,[this].concat(o))||this).propertyType="Sheen",r.parentTypes=[e.PropertyType.MATERIAL],r.extensionName="KHR_materials_sheen",r._sheenColorFactor=[0,0,0],r._sheenRoughnessFactor=0,r.sheenColorTexture=null,r.sheenColorTextureInfo=r.graph.link("sheenColorTextureInfo",s(r),new e.TextureInfo(r.graph)),r.sheenRoughnessTexture=null,r.sheenRoughnessTextureInfo=r.graph.link("sheenRoughnessTextureInfo",s(r),new e.TextureInfo(r.graph)),r}n(r,t);var o=r.prototype;return o.copy=function(r,n){return void 0===n&&(n=e.COPY_IDENTITY),t.prototype.copy.call(this,r,n),this._sheenColorFactor=r._sheenColorFactor,this._sheenRoughnessFactor=r._sheenRoughnessFactor,this.setSheenColorTexture(r.sheenColorTexture?n(r.sheenColorTexture.getChild()):null),this.sheenColorTextureInfo.getChild().copy(n(r.sheenColorTextureInfo.getChild()),n),this.setSheenRoughnessTexture(r.sheenRoughnessTexture?n(r.sheenRoughnessTexture.getChild()):null),this.sheenRoughnessTextureInfo.getChild().copy(n(r.sheenRoughnessTextureInfo.getChild()),n),this},o.dispose=function(){this.sheenColorTextureInfo.getChild().dispose(),this.sheenRoughnessTextureInfo.getChild().dispose(),t.prototype.dispose.call(this)},o.getSheenColorFactor=function(){return this._sheenColorFactor},o.getSheenColorHex=function(){return e.ColorUtils.factorToHex(this._sheenColorFactor)},o.setSheenColorFactor=function(e){return this._sheenColorFactor=e,this},o.setSheenColorHex=function(t){return e.ColorUtils.hexToFactor(t,this._sheenColorFactor),this},o.getSheenColorTexture=function(){return this.sheenColorTexture?this.sheenColorTexture.getChild():null},o.getSheenColorTextureInfo=function(){return this.sheenColorTexture?this.sheenColorTextureInfo.getChild():null},o.setSheenColorTexture=function(e){return this.sheenColorTexture=this.graph.linkTexture("sheenColorTexture",xe|de|ge,this,e),this},o.getSheenRoughnessFactor=function(){return this._sheenRoughnessFactor},o.setSheenRoughnessFactor=function(e){return this._sheenRoughnessFactor=e,this},o.getSheenRoughnessTexture=function(){return this.sheenRoughnessTexture?this.sheenRoughnessTexture.getChild():null},o.getSheenRoughnessTextureInfo=function(){return this.sheenRoughnessTexture?this.sheenRoughnessTextureInfo.getChild():null},o.setSheenRoughnessTexture=function(e){return this.sheenRoughnessTexture=this.graph.linkTexture("sheenRoughnessTexture",ye,this,e),this},r}(e.ExtensionProperty);ve.EXTENSION_NAME="KHR_materials_sheen",u([e.GraphChild],ve.prototype,"sheenColorTexture",void 0),u([e.GraphChild],ve.prototype,"sheenColorTextureInfo",void 0),u([e.GraphChild],ve.prototype,"sheenRoughnessTexture",void 0),u([e.GraphChild],ve.prototype,"sheenRoughnessTextureInfo",void 0);var me="KHR_materials_sheen",Ee=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(t=e.call.apply(e,[this].concat(n))||this).extensionName=me,t}n(t,e);var r=t.prototype;return r.createSheen=function(){return new ve(this.doc.getGraph(),this)},r.read=function(e){var t=this,r=e.jsonDoc,n=r.json.textures||[];return(r.json.materials||[]).forEach(function(r,o){if(r.extensions&&r.extensions[me]){var s=t.createSheen();e.materials[o].setExtension(me,s);var i=r.extensions[me];if(void 0!==i.sheenColorFactor&&s.setSheenColorFactor(i.sheenColorFactor),void 0!==i.sheenRoughnessFactor&&s.setSheenRoughnessFactor(i.sheenRoughnessFactor),void 0!==i.sheenColorTexture){var a=i.sheenColorTexture;s.setSheenColorTexture(e.textures[n[a.index].source]),e.setTextureInfo(s.getSheenColorTextureInfo(),a)}if(void 0!==i.sheenRoughnessTexture){var u=i.sheenRoughnessTexture;s.setSheenRoughnessTexture(e.textures[n[u.index].source]),e.setTextureInfo(s.getSheenRoughnessTextureInfo(),u)}}}),this},r.write=function(e){var t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(function(r){var n=r.getExtension(me);if(n){var o=e.materialIndexMap.get(r),s=t.json.materials[o];s.extensions=s.extensions||{};var i=s.extensions[me]={sheenColorFactor:n.getSheenColorFactor(),sheenRoughnessFactor:n.getSheenRoughnessFactor()};if(n.getSheenColorTexture()){var a=n.getSheenColorTexture(),u=n.getSheenColorTextureInfo();i.sheenColorTexture=e.createTextureInfoDef(a,u)}if(n.getSheenRoughnessTexture()){var c=n.getSheenRoughnessTexture(),l=n.getSheenRoughnessTextureInfo();i.sheenRoughnessTexture=e.createTextureInfoDef(c,l)}}}),this},t}(e.Extension);Ee.EXTENSION_NAME=me;var Ce=e.TextureChannel.R,_e=e.TextureChannel.G,Ie=e.TextureChannel.B,Ne=e.TextureChannel.A,Ae=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return(r=t.call.apply(t,[this].concat(o))||this).propertyType="Specular",r.parentTypes=[e.PropertyType.MATERIAL],r.extensionName="KHR_materials_specular",r._specularFactor=1,r._specularColorFactor=[1,1,1],r.specularTexture=null,r.specularTextureInfo=r.graph.link("specularTextureInfo",s(r),new e.TextureInfo(r.graph)),r.specularColorTexture=null,r.specularColorTextureInfo=r.graph.link("specularColorTextureInfo",s(r),new e.TextureInfo(r.graph)),r}n(r,t);var o=r.prototype;return o.copy=function(r,n){return void 0===n&&(n=e.COPY_IDENTITY),t.prototype.copy.call(this,r,n),this._specularFactor=r._specularFactor,this._specularColorFactor=r._specularColorFactor,this.setSpecularTexture(r.specularTexture?n(r.specularTexture.getChild()):null),this.specularTextureInfo.getChild().copy(n(r.specularTextureInfo.getChild()),n),this.setSpecularColorTexture(r.specularColorTexture?n(r.specularColorTexture.getChild()):null),this.specularColorTextureInfo.getChild().copy(n(r.specularColorTextureInfo.getChild()),n),this},o.dispose=function(){this.specularTextureInfo.getChild().dispose(),t.prototype.dispose.call(this)},o.getSpecularFactor=function(){return this._specularFactor},o.setSpecularFactor=function(e){return this._specularFactor=e,this},o.getSpecularColorFactor=function(){return this._specularColorFactor},o.setSpecularColorFactor=function(e){return this._specularColorFactor=e,this},o.getSpecularColorHex=function(){return e.ColorUtils.factorToHex(this._specularColorFactor)},o.setSpecularColorHex=function(t){return e.ColorUtils.hexToFactor(t,this._specularColorFactor),this},o.getSpecularTexture=function(){return this.specularTexture?this.specularTexture.getChild():null},o.getSpecularTextureInfo=function(){return this.specularTexture?this.specularTextureInfo.getChild():null},o.setSpecularTexture=function(e){return this.specularTexture=this.graph.linkTexture("specularTexture",Ne,this,e),this},o.getSpecularColorTexture=function(){return this.specularColorTexture?this.specularColorTexture.getChild():null},o.getSpecularColorTextureInfo=function(){return this.specularColorTexture?this.specularColorTextureInfo.getChild():null},o.setSpecularColorTexture=function(e){return this.specularColorTexture=this.graph.linkTexture("specularColorTexture",Ce|_e|Ie,this,e),this},r}(e.ExtensionProperty);Ae.EXTENSION_NAME="KHR_materials_specular",u([e.GraphChild],Ae.prototype,"specularTexture",void 0),u([e.GraphChild],Ae.prototype,"specularTextureInfo",void 0),u([e.GraphChild],Ae.prototype,"specularColorTexture",void 0),u([e.GraphChild],Ae.prototype,"specularColorTextureInfo",void 0);var Re="KHR_materials_specular",Se=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(e=t.call.apply(t,[this].concat(n))||this).extensionName=Re,e}n(r,t);var o=r.prototype;return o.createSpecular=function(){return new Ae(this.doc.getGraph(),this)},o.read=function(e){var t=this,r=e.jsonDoc,n=r.json.textures||[];return(r.json.materials||[]).forEach(function(r,o){if(r.extensions&&r.extensions[Re]){var s=t.createSpecular();e.materials[o].setExtension(Re,s);var i=r.extensions[Re];if(void 0!==i.specularFactor&&s.setSpecularFactor(i.specularFactor),void 0!==i.specularColorFactor&&s.setSpecularColorFactor(i.specularColorFactor),void 0!==i.specularTexture){var a=i.specularTexture;s.setSpecularTexture(e.textures[n[a.index].source]),e.setTextureInfo(s.getSpecularTextureInfo(),a)}if(void 0!==i.specularColorTexture){var u=i.specularColorTexture;s.setSpecularColorTexture(e.textures[n[u.index].source]),e.setTextureInfo(s.getSpecularColorTextureInfo(),u)}}}),this},o.write=function(t){var r=t.jsonDoc;return this.doc.getRoot().listMaterials().forEach(function(n){var o=n.getExtension(Re);if(o){var s=t.materialIndexMap.get(n),i=r.json.materials[s];i.extensions=i.extensions||{};var a=i.extensions[Re]={};if(1!==o.getSpecularFactor()&&(a.specularFactor=o.getSpecularFactor()),e.MathUtils.eq(o.getSpecularColorFactor(),[1,1,1])||(a.specularColorFactor=o.getSpecularColorFactor()),o.getSpecularTexture()){var u=o.getSpecularTexture(),c=o.getSpecularTextureInfo();a.specularTexture=t.createTextureInfoDef(u,c)}if(o.getSpecularColorTexture()){var l=o.getSpecularColorTexture(),h=o.getSpecularColorTextureInfo();a.specularColorTexture=t.createTextureInfoDef(l,h)}}}),this},r}(e.Extension);Se.EXTENSION_NAME=Re;var we=e.TextureChannel.R,Oe=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return(r=t.call.apply(t,[this].concat(o))||this).propertyType="Transmission",r.parentTypes=[e.PropertyType.MATERIAL],r.extensionName="KHR_materials_transmission",r._transmissionFactor=0,r.transmissionTexture=null,r.transmissionTextureInfo=r.graph.link("transmissionTextureInfo",s(r),new e.TextureInfo(r.graph)),r}n(r,t);var o=r.prototype;return o.copy=function(r,n){return void 0===n&&(n=e.COPY_IDENTITY),t.prototype.copy.call(this,r,n),this._transmissionFactor=r._transmissionFactor,this.setTransmissionTexture(r.transmissionTexture?n(r.transmissionTexture.getChild()):null),this.transmissionTextureInfo.getChild().copy(n(r.transmissionTextureInfo.getChild()),n),this},o.dispose=function(){this.transmissionTextureInfo.getChild().dispose(),t.prototype.dispose.call(this)},o.getTransmissionFactor=function(){return this._transmissionFactor},o.setTransmissionFactor=function(e){return this._transmissionFactor=e,this},o.getTransmissionTexture=function(){return this.transmissionTexture?this.transmissionTexture.getChild():null},o.getTransmissionTextureInfo=function(){return this.transmissionTexture?this.transmissionTextureInfo.getChild():null},o.setTransmissionTexture=function(e){return this.transmissionTexture=this.graph.linkTexture("transmissionTexture",we,this,e),this},r}(e.ExtensionProperty);Oe.EXTENSION_NAME="KHR_materials_transmission",u([e.GraphChild],Oe.prototype,"transmissionTexture",void 0),u([e.GraphChild],Oe.prototype,"transmissionTextureInfo",void 0);var Me="KHR_materials_transmission",Fe=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(t=e.call.apply(e,[this].concat(n))||this).extensionName=Me,t}n(t,e);var r=t.prototype;return r.createTransmission=function(){return new Oe(this.doc.getGraph(),this)},r.read=function(e){var t=this,r=e.jsonDoc,n=r.json.textures||[];return(r.json.materials||[]).forEach(function(r,o){if(r.extensions&&r.extensions[Me]){var s=t.createTransmission();e.materials[o].setExtension(Me,s);var i=r.extensions[Me];if(void 0!==i.transmissionFactor&&s.setTransmissionFactor(i.transmissionFactor),void 0!==i.transmissionTexture){var a=i.transmissionTexture;s.setTransmissionTexture(e.textures[n[a.index].source]),e.setTextureInfo(s.getTransmissionTextureInfo(),a)}}}),this},r.write=function(e){var t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(function(r){var n=r.getExtension(Me);if(n){var o=e.materialIndexMap.get(r),s=t.json.materials[o];s.extensions=s.extensions||{};var i=s.extensions[Me]={transmissionFactor:n.getTransmissionFactor()};if(n.getTransmissionTexture()){var a=n.getTransmissionTexture(),u=n.getTransmissionTextureInfo();i.transmissionTexture=e.createTextureInfoDef(a,u)}}}),this},t}(e.Extension);Fe.EXTENSION_NAME=Me;var be=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return(r=t.call.apply(t,[this].concat(o))||this).propertyType="Unlit",r.parentTypes=[e.PropertyType.MATERIAL],r.extensionName="KHR_materials_unlit",r}return n(r,t),r}(e.ExtensionProperty);be.EXTENSION_NAME="KHR_materials_unlit";var De="KHR_materials_unlit",Ge=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(t=e.call.apply(e,[this].concat(n))||this).extensionName=De,t}n(t,e);var r=t.prototype;return r.createUnlit=function(){return new be(this.doc.getGraph(),this)},r.read=function(e){var t=this;return(e.jsonDoc.json.materials||[]).forEach(function(r,n){r.extensions&&r.extensions[De]&&e.materials[n].setExtension(De,t.createUnlit())}),this},r.write=function(e){var t=e.jsonDoc;return this.doc.getRoot().listMaterials().forEach(function(r){if(r.getExtension(De)){var n=e.materialIndexMap.get(r),o=t.json.materials[n];o.extensions=o.extensions||{},o.extensions[De]={}}}),this},t}(e.Extension);Ge.EXTENSION_NAME=De;var Pe=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(e=t.call.apply(t,[this].concat(n))||this).propertyType="Mapping",e.parentTypes=["MappingList"],e.extensionName="KHR_materials_variants",e.material=null,e.variants=[],e}n(r,t);var o=r.prototype;return o.copy=function(r,n){var o=this;return void 0===n&&(n=e.COPY_IDENTITY),t.prototype.copy.call(this,r,n),this.setMaterial(r.material?n(r.material.getChild()):null),this.clearGraphChildList(this.variants),r.variants.forEach(function(e){return o.addVariant(n(e.getChild()))}),this},o.getMaterial=function(){return this.material?this.material.getChild():null},o.setMaterial=function(e){return this.material=this.graph.link("material",this,e),this},o.addVariant=function(e){var t=this.graph.link("variant",this,e);return this.addGraphChild(this.variants,t)},o.removeVariant=function(e){return this.removeGraphChild(this.variants,e)},o.listVariants=function(){return this.variants.map(function(e){return e.getChild()})},r}(e.ExtensionProperty);Pe.EXTENSION_NAME="KHR_materials_variants",u([e.GraphChild],Pe.prototype,"material",void 0),u([e.GraphChildList],Pe.prototype,"variants",void 0);var Be=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return(r=t.call.apply(t,[this].concat(o))||this).propertyType="MappingList",r.parentTypes=[e.PropertyType.PRIMITIVE],r.extensionName="KHR_materials_variants",r.mappings=[],r}n(r,t);var o=r.prototype;return o.copy=function(r,n){var o=this;return void 0===n&&(n=e.COPY_IDENTITY),t.prototype.copy.call(this,r,n),this.clearGraphChildList(this.mappings),r.mappings.forEach(function(e){return o.addMapping(n(e.getChild()))}),this},o.addMapping=function(e){var t=this.graph.link("mapping",this,e);return this.addGraphChild(this.mappings,t)},o.removeMapping=function(e){return this.removeGraphChild(this.mappings,e)},o.listMappings=function(){return this.mappings.map(function(e){return e.getChild()})},r}(e.ExtensionProperty);Be.EXTENSION_NAME="KHR_materials_variants",u([e.GraphChildList],Be.prototype,"mappings",void 0);var Ue=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return(r=t.call.apply(t,[this].concat(o))||this).propertyType="Variant",r.parentTypes=[e.PropertyType.ROOT,"MappingList"],r.extensionName="KHR_materials_variants",r}return n(r,t),r}(e.ExtensionProperty);Ue.EXTENSION_NAME="KHR_materials_variants";var je="KHR_materials_variants",Le=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(t=e.call.apply(e,[this].concat(n))||this).extensionName=je,t}n(t,e);var r=t.prototype;return r.createMappingList=function(){return new Be(this.doc.getGraph(),this)},r.createVariant=function(e){return void 0===e&&(e=""),new Ue(this.doc.getGraph(),this).setName(e)},r.createMapping=function(){return new Pe(this.doc.getGraph(),this)},r.listVariants=function(){return Array.from(this.properties).filter(function(e){return e instanceof Ue})},r.read=function(e){var t=this,r=e.jsonDoc;if(!r.json.extensions||!r.json.extensions[je])return this;var n=(r.json.extensions[je].variants||[]).map(function(e){return t.createVariant().setName(e.name||"")});return(r.json.meshes||[]).forEach(function(r,o){var s=e.meshes[o];(r.primitives||[]).forEach(function(r,o){if(r.extensions&&r.extensions[je]){for(var i,u=t.createMappingList(),c=a(r.extensions[je].mappings);!(i=c()).done;){var l=i.value,h=t.createMapping();void 0!==l.material&&h.setMaterial(e.materials[l.material]);for(var f,p=a(l.variants||[]);!(f=p()).done;)h.addVariant(n[f.value]);u.addMapping(h)}s.listPrimitives()[o].setExtension(je,u)}})}),this},r.write=function(e){var t=e.jsonDoc,r=this.listVariants();if(!r.length)return this;for(var n,o=[],s=new Map,i=a(r);!(n=i()).done;){var u=n.value;s.set(u,o.length),o.push(e.createPropertyDef(u))}for(var c,l=function(){var t=c.value,r=e.meshIndexMap.get(t);t.listPrimitives().forEach(function(t,n){var o=t.getExtension(je);if(o){var i=e.jsonDoc.json.meshes[r].primitives[n],a=o.listMappings().map(function(t){var r=e.createPropertyDef(t),n=t.getMaterial();return n&&(r.material=e.materialIndexMap.get(n)),r.variants=t.listVariants().map(function(e){return s.get(e)}),r});i.extensions=i.extensions||{},i.extensions[je]={mappings:a}}})},h=a(this.doc.getRoot().listMeshes());!(c=h()).done;)l();return t.json.extensions=t.json.extensions||{},t.json.extensions[je]={variants:o},this},t}(e.Extension);Le.EXTENSION_NAME=je;var ke=e.TextureChannel.G,He=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];return(r=t.call.apply(t,[this].concat(o))||this).propertyType="Transmission",r.parentTypes=[e.PropertyType.MATERIAL],r.extensionName="KHR_materials_volume",r._thicknessFactor=0,r._attenuationDistance=Infinity,r._attenuationColor=[1,1,1],r.thicknessTexture=null,r.thicknessTextureInfo=r.graph.link("thicknessTextureInfo",s(r),new e.TextureInfo(r.graph)),r}n(r,t);var o=r.prototype;return o.copy=function(r,n){return void 0===n&&(n=e.COPY_IDENTITY),t.prototype.copy.call(this,r,n),this._thicknessFactor=r._thicknessFactor,this._attenuationDistance=r._attenuationDistance,this._attenuationColor=[].concat(r._attenuationColor),this.setThicknessTexture(r.thicknessTexture?n(r.thicknessTexture.getChild()):null),this.thicknessTextureInfo.getChild().copy(n(r.thicknessTextureInfo.getChild()),n),this},o.dispose=function(){this.thicknessTextureInfo.getChild().dispose(),t.prototype.dispose.call(this)},o.getThicknessFactor=function(){return this._thicknessFactor},o.setThicknessFactor=function(e){return this._thicknessFactor=e,this},o.getThicknessTexture=function(){return this.thicknessTexture?this.thicknessTexture.getChild():null},o.getThicknessTextureInfo=function(){return this.thicknessTexture?this.thicknessTextureInfo.getChild():null},o.setThicknessTexture=function(e){return this.thicknessTexture=this.graph.linkTexture("thicknessTexture",ke,this,e),this},o.getAttenuationDistance=function(){return this._attenuationDistance},o.setAttenuationDistance=function(e){return this._attenuationDistance=e,this},o.getAttenuationColor=function(){return this._attenuationColor},o.setAttenuationColor=function(e){return this._attenuationColor=e,this},o.getAttenuationColorHex=function(){return e.ColorUtils.factorToHex(this._attenuationColor)},o.setAttenuationColorHex=function(t){return e.ColorUtils.hexToFactor(t,this._attenuationColor),this},r}(e.ExtensionProperty);He.EXTENSION_NAME="KHR_materials_volume",u([e.GraphChild],He.prototype,"thicknessTexture",void 0),u([e.GraphChild],He.prototype,"thicknessTextureInfo",void 0);var Ve="KHR_materials_volume",Xe=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(e=t.call.apply(t,[this].concat(n))||this).extensionName=Ve,e}n(r,t);var o=r.prototype;return o.createVolume=function(){return new He(this.doc.getGraph(),this)},o.read=function(e){var t=this,r=e.jsonDoc,n=r.json.textures||[];return(r.json.materials||[]).forEach(function(r,o){if(r.extensions&&r.extensions[Ve]){var s=t.createVolume();e.materials[o].setExtension(Ve,s);var i=r.extensions[Ve];if(void 0!==i.thicknessFactor&&s.setThicknessFactor(i.thicknessFactor),void 0!==i.attenuationDistance&&s.setAttenuationDistance(i.attenuationDistance),void 0!==i.attenuationColor&&s.setAttenuationColor(i.attenuationColor),void 0!==i.thicknessTexture){var a=i.thicknessTexture;s.setThicknessTexture(e.textures[n[a.index].source]),e.setTextureInfo(s.getThicknessTextureInfo(),a)}}}),this},o.write=function(t){var r=t.jsonDoc;return this.doc.getRoot().listMaterials().forEach(function(n){var o=n.getExtension(Ve);if(o){var s=t.materialIndexMap.get(n),i=r.json.materials[s];i.extensions=i.extensions||{};var a=i.extensions[Ve]={};if(o.getThicknessFactor()>0&&(a.thicknessFactor=o.getThicknessFactor()),Number.isFinite(o.getAttenuationDistance())&&(a.attenuationDistance=o.getAttenuationDistance()),e.MathUtils.eq(o.getAttenuationColor(),[1,1,1])||(a.attenuationColor=o.getAttenuationColor()),o.getThicknessTexture()){var u=o.getThicknessTexture(),c=o.getThicknessTextureInfo();a.thicknessTexture=t.createTextureInfoDef(u,c)}}}),this},r}(e.Extension);Xe.EXTENSION_NAME=Ve;var Ke="KHR_mesh_quantization",ze=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(t=e.call.apply(e,[this].concat(n))||this).extensionName=Ke,t}n(t,e);var r=t.prototype;return r.read=function(e){return this},r.write=function(e){return this},t}(e.Extension);ze.EXTENSION_NAME=Ke;var Ye="KHR_texture_basisu",qe=function(){function e(){}var r=e.prototype;return r.getSize=function(e){var r=t.read(new Uint8Array(e));return[r.pixelWidth,r.pixelHeight]},r.getChannels=function(e){var r=t.read(new Uint8Array(e)).dataFormatDescriptor[0];if(r.colorModel===t.KTX2Model.ETC1S)return 2===r.samples.length&&15==(15&r.samples[1].channelID)?4:3;if(r.colorModel===t.KTX2Model.UASTC)return 3==(15&r.samples[0].channelID)?4:3;throw new Error('Unexpected KTX2 colorModel, "'+r.colorModel+'".')},r.getGPUByteLength=function(e){for(var r=t.read(new Uint8Array(e)),n=this.getChannels(e)>3,o=0,s=0;s<r.levels.length;s++){var i=r.levels[s];o+=i.uncompressedByteLength?i.uncompressedByteLength:Math.max(1,Math.floor(r.pixelWidth/Math.pow(2,s)))/4*(Math.max(1,Math.floor(r.pixelHeight/Math.pow(2,s)))/4)*(n?16:8)}return o},e}(),Qe=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return(r=t.call.apply(t,[this].concat(o))||this).extensionName=Ye,r.prereadTypes=[e.PropertyType.TEXTURE],r}n(r,t),r.register=function(){e.ImageUtils.registerFormat("image/ktx2",new qe)};var o=r.prototype;return o.preread=function(e){return e.jsonDoc.json.textures.forEach(function(e){e.extensions&&e.extensions[Ye]&&(e.source=e.extensions[Ye].source)}),this},o.read=function(e){return this},o.write=function(e){var t=e.jsonDoc;return this.doc.getRoot().listTextures().forEach(function(r){if("image/ktx2"===r.getMimeType()){var n=e.imageIndexMap.get(r);t.json.textures.forEach(function(e){e.source===n&&(e.extensions=e.extensions||{},e.extensions[Ye]={source:e.source},delete e.source)})}}),this},r}(e.Extension);Qe.EXTENSION_NAME=Ye;var We=function(t){function r(){for(var r,n=arguments.length,o=new Array(n),s=0;s<n;s++)o[s]=arguments[s];return(r=t.call.apply(t,[this].concat(o))||this).propertyType="Transform",r.parentTypes=[e.PropertyType.TEXTURE_INFO],r.extensionName="KHR_texture_transform",r._offset=[0,0],r._rotation=0,r._scale=[1,1],r._texCoord=null,r}n(r,t);var o=r.prototype;return o.copy=function(r,n){return void 0===n&&(n=e.COPY_IDENTITY),t.prototype.copy.call(this,r,n),this._offset=r._offset,this._rotation=r._rotation,this._scale=r._scale,this._texCoord=r._texCoord,this},o.getOffset=function(){return this._offset},o.setOffset=function(e){return this._offset=e,this},o.getRotation=function(){return this._rotation},o.setRotation=function(e){return this._rotation=e,this},o.getScale=function(){return this._scale},o.setScale=function(e){return this._scale=e,this},o.getTexCoord=function(){return this._texCoord},o.setTexCoord=function(e){return this._texCoord=e,this},r}(e.ExtensionProperty);We.EXTENSION_NAME="KHR_texture_transform";var Je="KHR_texture_transform",Ze=function(t){function r(){for(var e,r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];return(e=t.call.apply(t,[this].concat(n))||this).extensionName=Je,e}n(r,t);var o=r.prototype;return o.createTransform=function(){return new We(this.doc.getGraph(),this)},o.read=function(e){for(var t=0,r=Array.from(e.textureInfos.entries());t<r.length;t++){var n=r[t],o=n[0],s=n[1];if(s.extensions&&s.extensions[Je]){var i=this.createTransform(),a=s.extensions[Je];void 0!==a.offset&&i.setOffset(a.offset),void 0!==a.rotation&&i.setRotation(a.rotation),void 0!==a.scale&&i.setScale(a.scale),void 0!==a.texCoord&&i.setTexCoord(a.texCoord),o.setExtension(Je,i)}}return this},o.write=function(t){for(var r=0,n=Array.from(t.textureInfoDefMap.entries());r<n.length;r++){var o=n[r],s=o[1],i=o[0].getExtension(Je);if(i){s.extensions=s.extensions||{};var a={},u=e.MathUtils.eq;u(i.getOffset(),[0,0])||(a.offset=i.getOffset()),0!==i.getRotation()&&(a.rotation=i.getRotation()),u(i.getScale(),[1,1])||(a.scale=i.getScale()),null!=i.getTexCoord()&&(a.texCoord=i.getTexCoord()),s.extensions[Je]=a}}return this},r}(e.Extension);Ze.EXTENSION_NAME=Je;var $e=[q,Z,oe,ae,Te,Se,Ee,Fe,Ge,Le,Xe,ze,Qe,Ze],et=[T,R,O].concat($e);exports.ALL_EXTENSIONS=et,exports.Clearcoat=re,exports.DracoMeshCompression=q,exports.IOR=se,exports.InstancedMesh=c,exports.KHRONOS_EXTENSIONS=$e,exports.Light=W,exports.LightsPunctual=Z,exports.Mapping=Pe,exports.MappingList=Be,exports.MaterialsClearcoat=oe,exports.MaterialsIOR=ae,exports.MaterialsPBRSpecularGlossiness=Te,exports.MaterialsSheen=Ee,exports.MaterialsSpecular=Se,exports.MaterialsTransmission=Fe,exports.MaterialsUnlit=Ge,exports.MaterialsVariants=Le,exports.MaterialsVolume=Xe,exports.MeshGPUInstancing=T,exports.MeshQuantization=ze,exports.MeshoptCompression=R,exports.PBRSpecularGlossiness=fe,exports.Sheen=ve,exports.Specular=Ae,exports.TextureBasisu=Qe,exports.TextureTransform=Ze,exports.TextureWebP=O,exports.Transform=We,exports.Transmission=Oe,exports.Unlit=be,exports.Variant=Ue,exports.Volume=He;
//# sourceMappingURL=extensions.js.map
